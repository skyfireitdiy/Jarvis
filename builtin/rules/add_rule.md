# 新增规则规范

## 规则文件基本要求

### 1. 文件位置（必须遵守）

**位置规范：**

- **必须**：规则文件应放置在项目的 `.jarvis/rules/` 目录

**文件路径：**

```text
{{ git_root_dir }}/.jarvis/rules/<rule_name>.md
```

**变量说明：**

- `{% raw %}{{ git_root_dir }}{% endraw %}`：当前 git 仓库的根目录

**注意：** 规则文件中的 `{% raw %}{{ git_root_dir }}{% endraw %}` 会在加载时被渲染为实际值。

### 2. 文件命名规范（必须遵守）

**命名规则：**

- **必须**：使用小写字母
- **必须**：使用下划线 `_` 分隔单词
- **必须**：使用 `.md` 后缀
- **禁止**：使用空格、连字符 `-` 或大写字母

**命名示例：**

- ✅ 正确：`code_review.md`, `tdd.md`, `security.md`
- ❌ 错误：`CodeReview.md`, `code-review.md`, `CODE_REVIEW.md`

**命名建议：**

- 使用简短、描述性的名称
- 反映规则的核心用途
- 避免过于通用的名称（如 `rule.md`）

### 3. 文件格式要求（必须遵守）

**Markdown 格式：**

- **必须**：使用 Markdown 格式
- **必须**：使用 UTF-8 编码
- **必须**：使用 LF 换行符（Unix 风格）

**结构要求：**

```markdown
# 规则标题

## 简介/背景

（可选）简要说明规则的用途和背景

## 你必须遵守的原则

（必需）规则的核心原则

### 具体要求1

**要求说明：**

- **必须**：具体要求
- **禁止**：禁止事项

## 你必须执行的操作

（必需）具体的执行步骤或规范

## 检查清单

（可选）完成后的验证项

- [ ] 检查项1
- [ ] 检查项2
```

### 4. 内容编写要求（必须遵守）

**语言风格：**

- **必须**：使用清晰、简洁的语言
- **必须**：使用肯定式表述（"必须"、"禁止"）
- **必须**：避免模糊的表达

**结构化要求：**

- 使用分级标题组织内容（`#`、`##`、`###`）
- 使用列表罗列要求（`-` 或 `1.`）
- 使用代码块提供示例
- 使用加粗强调关键词（`**必须**`、`**禁止**`）

**完整性要求：**

- 说明规则的适用场景
- 提供具体的示例代码
- 列出必须遵守的要求
- 列出禁止的事项
- 提供验证或检查清单

## Jinja2 变量使用指南

### 可用的内置变量

规则文件中可以使用以下 Jinja2 模板变量：

| 变量名                                       | 说明                 | 示例值                   |
| -------------------------------------------- | -------------------- | ------------------------ |
| `{% raw %}{{ rule_file_dir }}{% endraw %}`   | 当前规则文件所在目录 | `/path/to/builtin/rules` |
| `{% raw %}{{ git_root_dir }}{% endraw %}`    | Git 仓库根目录       | `/home/user/project`     |
| `{% raw %}{{ current_dir }}{% endraw %}`     | 当前工作目录         | `/home/user/project/src` |
| `{% raw %}{{ jarvis_src_dir }}{% endraw %}`  | Jarvis 源码目录      | `/home/user/jarvis`      |
| `{% raw %}{{ jarvis_data_dir }}{% endraw %}` | Jarvis 数据目录      | `/home/user/.jarvis`     |

### 变量使用示例

#### 示例 1：引用其他规则文件

```markdown
### 相关规则

- 参考代码审查规则：`{% raw %}{{ rule_file_dir }}{% endraw %}/code_review.md`
- 参考安全规则：`{% raw %}{{ rule_file_dir }}{% endraw %}/security.md`
```

#### 示例 2：指定项目路径

```markdown
### 文件放置位置

**测试文件必须放置在：**

- `{% raw %}{{ git_root_dir }}{% endraw %}/tests/`
- `{% raw %}{{ git_root_dir }}{% endraw %}/src/{% raw %}{{ module_name }}{% endraw %}/tests/`
```

#### 示例 3：使用条件逻辑

```markdown
{% if git_root_dir == current_dir %}
**注意**：当前在项目根目录
{% else %}
**注意**：当前在子目录中
{% endif %}
```

## 规则模板

以下是一个完整的规则文件模板，可直接复制使用：

````markdown
# [规则名称]

## 规则简介

简要描述规则的用途、适用场景和预期效果。

## 你必须遵守的原则

### 1. 原则名称

**要求说明：**

- **必须**：具体要求1
- **必须**：具体要求2
- **禁止**：禁止事项

**示例：**

```python
# 示例代码
def example():
    pass
```
````

## 你必须执行的操作

### 操作1：操作名称

**执行步骤：**

1. 步骤1
2. 步骤2
3. 步骤3

**注意事项：**

- 注意事项1
- 注意事项2

## 检查清单

在完成任务后，你必须确认：

- [ ] 检查项1
- [ ] 检查项2
- [ ] 检查项3

## 相关资源

- 参考文档：`related_rule.md`

```text

```

## 最佳实践

### 1. 规则设计原则

- **单一职责**：每个规则只关注一个主题
- **可操作性**：规则必须具体、可执行
- **可验证**：规则结果必须可检查
- **简洁明了**：避免冗长和重复

### 2. 常见错误

- ❌ **规则过于抽象**："代码要写得好看"
- ✅ **规则具体明确**："函数长度不超过 50 行"

- ❌ **规则相互冲突**：规则 A 要求 X，规则 B 要求非 X
- ✅ **规则协调一致**：相关规则应相互补充

- ❌ **缺少示例**：只有文字描述，没有示例代码
- ✅ **提供示例**：包含正面和反面的示例

### 3. 规则维护

- 定期审查规则的适用性
- 根据项目发展更新规则
- 删除过时或不再使用的规则
- 记录规则变更历史

## 规则加载验证

### 验证方法

创建规则后，使用以下命令验证规则是否正确加载：

```bash
# 列出所有可用的内置规则
jarvis rule list

# 查看特定规则内容
jarvis rule show <rule_name>
```

### 验证检查项

- [ ] 规则文件名符合命名规范
- [ ] 规则文件使用 UTF-8 编码
- [ ] 规则文件使用 Markdown 格式
- [ ] jinja2 变量语法正确
- [ ] 规则内容结构完整
- [ ] 规则可以通过 `jarvis rule show` 正确加载

## 示例：创建一个简单的规则

假设我们需要创建一个"命名规范"规则：

### 步骤 1：创建文件

```bash
touch builtin/rules/naming_convention.md
```

### 步骤 2：编写内容

````markdown
# 命名规范规则

## 你必须遵守的命名原则

### 1. 变量命名

**要求：**

- **必须**：使用小写字母和下划线
- **必须**：使用描述性名称
- **禁止**：使用单字母变量（除循环变量外）

**示例：**

```python
# ✅ 正确
user_name = "John"
max_retry_count = 3

# ❌ 错误
userName = "John"  # 应使用下划线
x = "John"  # 应使用描述性名称
```
````

### 2. 函数命名

**要求：**

- **必须**：使用小写字母和下划线
- **必须**：使用动词开头
- **禁止**：使用驼峰命名法

**示例：**

```python
# ✅ 正确
def get_user_name():
    pass

def calculate_total():
    pass

# ❌ 错误
def getUserName():  # 应使用下划线
def UserName():  # 应使用动词开头
```

### 示例检查清单

- [ ] 所有变量使用小写和下划线

- [ ] 所有函数使用动词开头

- [ ] 所有命名具有描述性

```

```
