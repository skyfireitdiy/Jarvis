# zlib_rs é¡¹ç›®åˆ†ææŠ¥å‘Š

## 1. é¡¹ç›®æ¦‚è¿°

| é¡¹ç›®ä¿¡æ¯ | æè¿° |
|---------|------|
| é¡¹ç›®åç§° | zlib_rs |
| ç‰ˆæœ¬ | 0.1.0 |
| è¯­è¨€ | Rust |
| ä»£ç è¡Œæ•° | 564 è¡Œï¼ˆä¸å«ç©ºè¡Œå’Œæ³¨é‡Šçº¦ 281 è¡Œï¼‰ |
| æºæ–‡ä»¶æ•° | 7 ä¸ª Rust æ–‡ä»¶ |

### æ¨¡å—ç»“æ„

   ```
src/
â”œâ”€â”€ lib.rs              # åº“å…¥å£ï¼Œå¯¼å‡ºæ¨¡å—
â”œâ”€â”€ adler32/
â”‚   â”œâ”€â”€ mod.rs          # Adler-32 æ¨¡å—å…¥å£
â”‚   â”œâ”€â”€ core.rs         # æ ¸å¿ƒå®ç°ï¼ˆå¾…å®ç°ï¼‰
â”‚   â””â”€â”€ combine.rs      # æ ¡éªŒå’Œåˆå¹¶åŠŸèƒ½
â”œâ”€â”€ ffi/
â”‚   â”œâ”€â”€ mod.rs          # FFI æ¥å£å®ç°
â”‚   â””â”€â”€ types.rs        # FFI ç±»å‹å®šä¹‰ï¼ˆå¾…å®ç°ï¼‰
â””â”€â”€ bin/
    â””â”€â”€ zlib_rs.rs      # CLI å…¥å£ï¼ˆå ä½ï¼‰
   ```

---

## 2. Unsafe ä½¿ç”¨æƒ…å†µåˆ†æ

### 2.1 ç»Ÿè®¡æ¦‚è§ˆ

| ç±»åˆ« | æ•°é‡ | ä½ç½® |
|------|------|------|
| unsafe å‡½æ•°å£°æ˜ | 2 | `src/ffi/mod.rs` |
| unsafe ä»£ç å—ï¼ˆå®ç°ï¼‰ | 2 | `src/ffi/mod.rs` |
| unsafe ä»£ç å—ï¼ˆæµ‹è¯•ï¼‰ | 15 | `src/ffi/mod.rs` (æµ‹è¯•æ¨¡å—) |

### 2.2 è¯¦ç»†åˆ†æ

#### Unsafe å‡½æ•°

1. **`adler32_z`** (ç¬¬ 45 è¡Œ)
   ```rust
   pub unsafe extern "C" fn adler32_z(adler: u32, buf: *const u8, len: usize) -> u32
   ```
   - **ç”¨é€”**: æä¾› C ABI å…¼å®¹çš„ Adler-32 è®¡ç®—æ¥å£
   - **é£é™©ç‚¹**: éœ€è¦è°ƒç”¨è€…ç¡®ä¿ `buf` æŒ‡é’ˆæœ‰æ•ˆä¸”å¯è¯» `len` å­—èŠ‚
   - **å®‰å…¨æªæ–½**: ç©ºæŒ‡é’ˆæ£€æŸ¥ï¼ˆè¿”å›åˆå§‹å€¼ 1ï¼‰

2. **`adler32`** (ç¬¬ 70 è¡Œ)
   ```rust
   pub unsafe extern "C" fn adler32(adler: u32, buf: *const u8, len: u32) -> u32
   ```
   - **ç”¨é€”**: ä¸ zlib åŸå§‹æ¥å£å…¼å®¹çš„ Adler-32 è®¡ç®—
   - **é£é™©ç‚¹**: åŒä¸Š
   - **å®‰å…¨æªæ–½**: ç©ºæŒ‡é’ˆæ£€æŸ¥

#### Unsafe ä»£ç å—

1. **`std::slice::from_raw_parts`** (ç¬¬ 57ã€82 è¡Œ)
   ```rust
   let slice = unsafe { std::slice::from_raw_parts(buf, len) };
   ```
   - **ç”¨é€”**: å°†åŸå§‹æŒ‡é’ˆè½¬æ¢ä¸º Rust åˆ‡ç‰‡
   - **å‰ç½®æ¡ä»¶**: å·²è¿›è¡Œç©ºæŒ‡é’ˆå’Œé›¶é•¿åº¦æ£€æŸ¥
   - **é£é™©ç­‰çº§**: âš ï¸ ä¸­ç­‰ï¼ˆä¾èµ–è°ƒç”¨è€…ä¿è¯å†…å­˜æœ‰æ•ˆæ€§ï¼‰

### 2.3 å®‰å…¨æ€§è¯„ä¼°

| è¯„ä¼°é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| ç©ºæŒ‡é’ˆæ£€æŸ¥ | âœ… é€šè¿‡ | æ‰€æœ‰ FFI å‡½æ•°éƒ½æœ‰ç©ºæŒ‡é’ˆæ£€æŸ¥ |
| è¾¹ç•Œæ£€æŸ¥ | âš ï¸ éƒ¨åˆ† | ä¾èµ–è°ƒç”¨è€…ä¼ å…¥æ­£ç¡®çš„é•¿åº¦ |
| æ–‡æ¡£è¯´æ˜ | âœ… é€šè¿‡ | æ‰€æœ‰ unsafe å‡½æ•°éƒ½æœ‰ `# Safety` æ–‡æ¡£ |
| æµ‹è¯•è¦†ç›– | âœ… é€šè¿‡ | è¾¹ç•Œæ¡ä»¶æœ‰æµ‹è¯•è¦†ç›– |

---

## 3. å•å…ƒæµ‹è¯•æƒ…å†µ

### 3.1 æµ‹è¯•ç»Ÿè®¡

| æ¨¡å— | æµ‹è¯•æ•°é‡ | çŠ¶æ€ |
|------|----------|------|
| `adler32::combine` | 16 | âœ… å…¨éƒ¨é€šè¿‡ |
| `ffi` | 12 | âœ… å…¨éƒ¨é€šè¿‡ |
| **æ€»è®¡** | **28** | âœ… **å…¨éƒ¨é€šè¿‡** |

### 3.2 æµ‹è¯•è¦†ç›–è¯¦æƒ…

#### adler32::combine æ¨¡å—æµ‹è¯•ï¼ˆ16 ä¸ªï¼‰

| æµ‹è¯•åç§° | æµ‹è¯•ç›®çš„ |
|----------|----------|
| `test_negative_len_returns_invalid` | è´Ÿæ•°é•¿åº¦è¿”å› 0xffffffff |
| `test_zero_len` | é›¶é•¿åº¦å¤„ç† |
| `test_initial_adler_values` | åˆå§‹å€¼ï¼ˆ1ï¼‰åˆå¹¶ |
| `test_typical_values` | å…¸å‹å€¼è®¡ç®— |
| `test_len_equals_base` | è¾¹ç•Œå€¼ï¼šlen2 = BASE |
| `test_len_greater_than_base` | è¾¹ç•Œå€¼ï¼šlen2 > BASE |
| `test_large_values` | å¤§æ•°å€¼å¤„ç† |
| `test_max_len` | len2 = i64::MAX |
| `test_zero_adler_values` | é›¶å€¼æ ¡éªŒå’Œ |
| `test_sum1_double_reduction` | sum1 åŒé‡è§„çº¦ |
| `test_adler32_combine_wrapper_consistency` | å…¬å…±æ¥å£ä¸€è‡´æ€§ |
| `test_adler32_combine_*` | å…¬å…±æ¥å£å„åœºæ™¯æµ‹è¯• (5ä¸ª) |

#### ffi æ¨¡å—æµ‹è¯•ï¼ˆ12 ä¸ªï¼‰

| æµ‹è¯•åç§° | æµ‹è¯•ç›®çš„ |
|----------|----------|
| `test_null_pointer_returns_initial` | ç©ºæŒ‡é’ˆè¿”å›åˆå§‹å€¼ |
| `test_zero_length_returns_original` | é›¶é•¿åº¦è¿”å›åŸå€¼ |
| `test_empty_data` | ç©ºæ•°æ®å¤„ç† |
| `test_single_byte` | å•å­—èŠ‚æ ¡éªŒå’Œ |
| `test_multiple_bytes` | å¤šå­—èŠ‚æ ¡éªŒå’Œ ("abc") |
| `test_incremental_calculation` | å¢é‡è®¡ç®— |
| `test_longer_data` | é•¿æ•°æ® |
| `test_zero_data` | å…¨é›¶æ•°æ® |
| `test_max_byte_data` | å…¨ 0xFF æ•°æ® |
| `test_initial_zero_equals_one` | åˆå§‹å€¼ 0 ç­‰äº 1 |
| `test_large_buffer` | å¤§ç¼“å†²åŒº (64KB) |

---

## 4. ä¸åŸå§‹ C ä»£ç æ¥å£å¯¹é½æƒ…å†µ

### 4.1 æ¥å£å¯¹æ¯”

| C å‡½æ•° | Rust å®ç° | å¯¹é½çŠ¶æ€ |
|--------|-----------|----------|
| `adler32_z(uLong, const Bytef*, z_size_t)` | `adler32_z(u32, *const u8, usize)` | âœ… å®Œå…¨å¯¹é½ |
| `adler32(uLong, const Bytef*, uInt)` | `adler32(u32, *const u8, u32)` | âœ… å®Œå…¨å¯¹é½ |
| `adler32_combine(uLong, uLong, z_off_t)` | `adler32_combine(u32, u32, i64)` | âœ… å®Œå…¨å¯¹é½ |
| `adler32_combine64(uLong, uLong, z_off64_t)` | `adler32_combine64(u32, u32, i64)` | âœ… å®Œå…¨å¯¹é½ |
| `adler32_combine_` (internal) | `adler32_combine_` (private) | âœ… å®Œå…¨å¯¹é½ |

### 4.2 ç­¾åè¯¦æƒ…

| å±æ€§ | C ç‰ˆæœ¬ | Rust ç‰ˆæœ¬ | åŒ¹é… |
|------|--------|-----------|------|
| å¯¼å‡ºåç§° | `#[no_mangle]` | âœ… | âœ… |
| è°ƒç”¨çº¦å®š | `ZEXPORT` | `extern "C"` | âœ… |
| è¿”å›ç±»å‹ | `uLong` (32-bit) | `u32` | âœ… |
| æŒ‡é’ˆç±»å‹ | `const Bytef*` | `*const u8` | âœ… |

---

## 5. åŠŸèƒ½å¯¹é½æƒ…å†µ

### 5.1 åŠŸèƒ½å¯¹æ¯”çŸ©é˜µ

| åŠŸèƒ½ | C å®ç° | Rust å®ç° | çŠ¶æ€ |
|------|--------|-----------|------|
| åŸºæœ¬ Adler-32 è®¡ç®— | `adler32_z` | `adler32_z` | âœ… å®Œå…¨å®ç° |
| çŸ­é•¿åº¦å‚æ•°ç‰ˆæœ¬ | `adler32` | `adler32` | âœ… å®Œå…¨å®ç° |
| æ ¡éªŒå’Œåˆå¹¶ | `adler32_combine_` | `adler32_combine_` | âœ… å®Œå…¨å®ç° |
| 32 ä½é•¿åº¦åˆå¹¶æ¥å£ | `adler32_combine` | `adler32_combine` | âœ… å®Œå…¨å®ç° |
| 64 ä½é•¿åº¦åˆå¹¶æ¥å£ | `adler32_combine64` | `adler32_combine64` | âœ… å®Œå…¨å®ç° |
| ç©ºæŒ‡é’ˆå¤„ç† | è¿”å› 1 | è¿”å› 1 | âœ… ä¸€è‡´ |
| è´Ÿé•¿åº¦å¤„ç† | è¿”å› 0xffffffff | è¿”å› 0xffffffff | âœ… ä¸€è‡´ |

### 5.2 å®ç°å·®å¼‚

| æ–¹é¢ | C å®ç° | Rust å®ç° | è¯´æ˜ |
|------|--------|-----------|------|
| æ ¸å¿ƒè®¡ç®— | æ‰‹å†™å¾ªç¯å±•å¼€ + å® | `adler` crate | Rust ä½¿ç”¨å¤–éƒ¨åº“ |
| æ€§èƒ½ä¼˜åŒ– | DO16 å®å±•å¼€ | åº“å†…éƒ¨ä¼˜åŒ– | å®ç°æ–¹å¼ä¸åŒ |
| NO_DIVIDE ä¼˜åŒ– | æ¡ä»¶ç¼–è¯‘æ”¯æŒ | ä¸é€‚ç”¨ | Rust ç‰ˆæœ¬æœªå®ç° |
| NMAX æ‰¹å¤„ç† | 5552 å­—èŠ‚å— | åº“å†…éƒ¨å¤„ç† | å®ç°æ–¹å¼ä¸åŒ |

### 5.3 æœªå®ç°åŠŸèƒ½

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| `core.rs` æ ¸å¿ƒè®¡ç®— | ğŸš§ å¾…å®ç° | å½“å‰ä½¿ç”¨ `adler` crate |
| `types.rs` FFI ç±»å‹ | ğŸš§ å¾…å®ç° | å¦‚ `z_stream`ã€`gz_header` |
| CLI åŠŸèƒ½ | ğŸš§ å¾…å®ç° | ä»…æœ‰å ä½ `main()` |

---

## 6. æ³¨é‡Šæƒ…å†µ

### 6.1 æ–‡æ¡£æ³¨é‡Šè¦†ç›–

| æ¨¡å—/æ–‡ä»¶ | æ¨¡å—çº§æ³¨é‡Š | å‡½æ•°çº§æ³¨é‡Š | çŠ¶æ€ |
|-----------|------------|------------|------|
| `lib.rs` | âœ… å®Œæ•´ | N/A | âœ… |
| `adler32/mod.rs` | âœ… å®Œæ•´ | N/A | âœ… |
| `adler32/core.rs` | âœ… å®Œæ•´ | N/A (TODO) | âœ… |
| `adler32/combine.rs` | âœ… å®Œæ•´ | âœ… å®Œæ•´ | âœ… |
| `ffi/mod.rs` | âœ… å®Œæ•´ | âœ… å®Œæ•´ | âœ… |
| `ffi/types.rs` | âœ… å®Œæ•´ | N/A (TODO) | âœ… |
| `bin/zlib_rs.rs` | âœ… å®Œæ•´ | âœ… å®Œæ•´ | âœ… |

### 6.2 æ³¨é‡Šè´¨é‡è¯„ä¼°

| è¯„ä¼°é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| æ¨¡å—æ–‡æ¡£ (`//!`) | âœ… ä¼˜ç§€ | æ‰€æœ‰æ¨¡å—éƒ½æœ‰æè¿° |
| å‡½æ•°æ–‡æ¡£ (`///`) | âœ… ä¼˜ç§€ | å…¬å…±å‡½æ•°éƒ½æœ‰å®Œæ•´æ–‡æ¡£ |
| å‚æ•°è¯´æ˜ | âœ… ä¼˜ç§€ | ä½¿ç”¨ `# å‚æ•°` æ ¼å¼ |
| è¿”å›å€¼è¯´æ˜ | âœ… ä¼˜ç§€ | ä½¿ç”¨ `# è¿”å›å€¼` æ ¼å¼ |
| Safety è¯´æ˜ | âœ… ä¼˜ç§€ | unsafe å‡½æ•°éƒ½æœ‰ `# Safety` |
| å†…è”æ³¨é‡Š | âœ… è‰¯å¥½ | å…³é”®é€»è¾‘æœ‰è§£é‡Š |
| TODO æ ‡è®° | âœ… åˆç† | å¾…å®ç°åŠŸèƒ½æœ‰æ ‡è®° |

### 6.3 æ–‡æ¡£æµ‹è¯•

- **Doc-tests**: 0 ä¸ªï¼ˆæœªæ·»åŠ ä»£ç ç¤ºä¾‹ï¼‰
- **å»ºè®®**: å¯åœ¨å…¬å…±å‡½æ•°æ·»åŠ  `# Examples` ä»£ç ç¤ºä¾‹

---

## 7. æ€»ç»“

### 7.1 é¡¹ç›®æˆç†Ÿåº¦è¯„ä¼°

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| æ¥å£å®Œæ•´æ€§ | â­â­â­â­â­ | 5/5 ä¸ª C æ¥å£å®Œå…¨å¯¹é½ |
| åŠŸèƒ½æ­£ç¡®æ€§ | â­â­â­â­â­ | 28/28 æµ‹è¯•å…¨éƒ¨é€šè¿‡ |
| å®‰å…¨æ€§ | â­â­â­â­â˜† | unsafe ä½¿ç”¨åˆç†ï¼Œæœ‰å®Œå–„æ£€æŸ¥ |
| æ–‡æ¡£è´¨é‡ | â­â­â­â­â­ | æ³¨é‡Šå®Œæ•´ï¼Œæ ¼å¼è§„èŒƒ |
| ä»£ç è§„æ¨¡ | â­â­â­â˜†â˜† | ä»…å®ç° Adler-32ï¼Œå…¶ä»–å¾…æ‰©å±• |

### 7.2 å»ºè®®æ”¹è¿›

1. **å®ç°æ ¸å¿ƒè®¡ç®—**ï¼šå°† `adler` crate çš„ä¾èµ–æ›¿æ¢ä¸ºè‡ªå®ç°ï¼Œç¡®ä¿å®Œå…¨ä¸€è‡´
2. **æ·»åŠ æ–‡æ¡£ç¤ºä¾‹**ï¼šä¸ºå…¬å…±å‡½æ•°æ·»åŠ  `# Examples` æ®µè½
3. **æ‰©å±• FFI ç±»å‹**ï¼šå®ç° `z_stream` ç­‰æ ¸å¿ƒæ•°æ®ç»“æ„
4. **æ€§èƒ½åŸºå‡†æµ‹è¯•**ï¼šæ·»åŠ ä¸åŸå§‹ C å®ç°çš„æ€§èƒ½å¯¹æ¯”
5. **å®Œå–„ CLI**ï¼šå®ç°å®ç”¨çš„å‘½ä»¤è¡ŒåŠŸèƒ½

---

*æŠ¥å‘Šç”Ÿæˆæ—¶é—´ï¼š2024 å¹´*
*åŸºäº commit: b6a8e98c408feb70c9dc42027beede702e409b6d*
