{
  "id": "20260131_193600_902089",
  "type": "project_long_term",
  "tags": [
    "规则系统",
    "rule",
    "load_rule",
    "架构分析",
    "阶段2",
    "知识自主积累"
  ],
  "content": "## 规则系统架构分析报告\n\n### 1. 系统架构概览\n\n```\n┌─────────────────────────────────────────────────────────┐\n│                    规则系统架构                          │\n├─────────────────────────────────────────────────────────┤\n│  工具层                                                  │\n│  ├── LoadRuleTool (jarvis_tools/load_rule.py)           │\n│  │   └── 读取规则文件并渲染jinja2模板                    │\n│  └── RulesManager (jarvis_agent/rules_manager.py)       │\n│      └── 管理规则加载、优先级、索引                       │\n├─────────────────────────────────────────────────────────┤\n│  存储层                                                  │\n│  ├── 项目级: .jarvis/rules/*.md                         │\n│  ├── 全局级: ~/.jarvis/rules/*.md                       │\n│  ├── 内置规则: builtin/rules/*.md                       │\n│  ├── 中心仓库: 可配置的Git仓库                           │\n│  └── YAML规则: rules.yaml（项目/全局/中心）              │\n├─────────────────────────────────────────────────────────┤\n│  渲染层                                                  │\n│  └── template_utils.py                                  │\n│      └── jinja2模板渲染，支持内置变量                     │\n└─────────────────────────────────────────────────────────┘\n```\n\n### 2. 规则文件格式\n\n**Markdown格式**，支持jinja2模板变量：\n- `{{ current_dir }}`: 当前工作目录\n- `{{ git_root_dir }}`: Git根目录\n- `{{ jarvis_src_dir }}`: Jarvis源码目录\n- `{{ jarvis_data_dir }}`: Jarvis数据目录\n- `{{ rule_file_dir }}`: 规则文件所在目录\n\n**规则内容结构**（推荐）：\n```markdown\n# 规则名称\n\n## 你必须遵循的工作流程\n## 你必须遵守的原则\n## 实践指导\n## 代码示例\n## 执行检查清单\n```\n\n### 3. 规则加载机制\n\n**优先级顺序**（从高到低）：\n1. 中心规则仓库（central:）\n2. 项目规则（project:）→ `.jarvis/rules/`\n3. 全局规则（global:）→ `~/.jarvis/rules/`\n4. 配置目录（config0:）\n5. 内置规则（builtin:）→ `builtin/rules/`\n\n**规则名称前缀**：\n- `builtin:` - 内置规则目录\n- `project:` - 项目规则目录\n- `global:` - 全局规则目录\n- `central:` - 中心规则仓库\n- `project_yaml:` - 项目rules.yaml\n- `global_yaml:` - 全局rules.yaml\n- 无前缀 - 按优先级自动查找\n\n### 4. 核心接口\n\n**LoadRuleTool.execute(args)**：\n- file_path: 规则文件路径\n- 返回: {success, stdout, stderr}\n\n**RulesManager方法**：\n- `get_named_rule(rule_name)`: 获取指定规则\n- `load_all_rules(rule_names)`: 加载所有规则\n- `get_all_available_rule_names()`: 获取所有可用规则名\n\n### 5. 可扩展点\n\n1. **规则自动生成**：当前只有手动创建，可扩展为自动生成\n2. **规则推荐**：当前无智能推荐，可增强语义匹配\n3. **规则质量评估**：当前无质量评估机制\n4. **规则版本管理**：当前无版本控制\n5. **规则关联**：当前规则之间无关联关系\n6. **规则索引**：builtin_rules.md提供索引，可扩展为动态索引\n\n### 6. 与方法论系统对比\n\n| 特性 | 规则系统 | 方法论系统 |\n|------|----------|------------|\n| 存储格式 | Markdown | JSON |\n| 模板支持 | jinja2 | 无 |\n| 优先级 | 多级（中心/项目/全局/内置） | 两级（项目/全局） |\n| 索引文件 | builtin_rules.md | 无 |\n| 工具接口 | load_rule | methodology |\n| 操作类型 | 只读 | add/update/delete |\n\n### 7. 后续开发建议\n\n1. **规则自动生成器**：创建`jarvis_rule_generator`模块\n   - 分析代码模式和最佳实践\n   - 生成符合格式的规则文件\n   - 支持jinja2模板变量\n\n2. **集成方式**：\n   - 生成Markdown格式规则文件\n   - 存储到`.jarvis/rules/`目录\n   - 可选更新builtin_rules.md索引\n\n3. **质量评估**：\n   - 完整性检查（是否包含必要章节）\n   - 可执行性检查（步骤是否清晰）\n   - 重复性检查（是否与现有规则重复）",
  "created_at": "2026-01-31T19:36:00.902104",
  "updated_at": "2026-01-31T19:36:00.902107"
}
