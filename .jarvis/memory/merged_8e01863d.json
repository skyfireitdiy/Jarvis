{
  "content": "Jarvis C2Rust 多Agent系统架构设计与转译子命令实施方案\n\n【总体目标】\n构建完整的 C/C++ -> Rust 渐进迁移系统，包含多Agent编排架构与独立转译子命令，支持自动化、断点续跑与状态管理。\n\n【多Agent系统架构设计（2025-10-17）】\n\n【核心流程】\n1) 识别当前代码的构建框架与流程，产出一键编译脚本\n2) 识别/构建测试用例运行流程，产出测试脚本（若缺失则创建测试框架与空用例）\n3) 建立Rust静态库（staticlib）工程并与现有工程链接，产出运行测试用例脚本\n4) 逐步发现C/C++单元，补充用例并保证通过；随后以Rust实现替换，并在未转换依赖处使用extern/unsafe调用\n5) 用例通过后优化Rust实现，减少不必要的unsafe，保持用例通过\n6) 迭代直到全量切换到Rust\n\n【设计要求】\n- 除主Agent外尽量无状态或使用Sub Agent\n- 支持断点续转：通过关键文件（如进度状态文件）识别转换进度\n- 遵循项目现有multi_agent风格（优先YAML编排），最小侵入、可回滚\n\n【预期产物与路径】\n- 编排：builtin/multi_agent/c2rust_migration.yaml（主编排）\n- 进度文件：builtin/multi_agent/c2rust_state.json（断点续转状态）\n- 脚本：scripts/build.sh、scripts/test.sh、scripts/run_tests_with_rust.sh\n- Rust桥接工程：rust_bridge/（Cargo.toml、build.rs、src/lib.rs，crate-type为staticlib）\n\n【转译子命令架构（2025-10-24）】\n\n【位置与命名】\n- 在 src/jarvis/jarvis_c2rust 下新增模块 transpiler.py，在 cli.py 中新增子命令 transpile，与现有 scan/plan 并列\n\n【数据输入】\n- 依赖 scanner 产物：<root>/.jarvis/c2rust/functions.jsonl（含函数位置信息、调用关系、拓扑顺序）与 types.jsonl（如有）\n- 源码根目录：默认当前工作目录或从扫描记录推断\n\n【转译流程（按 scanner 生成的函数顺序）】\n1) 为每个待转函数创建一个 LLM Agent（模块选择与签名生成Agent）：\n   - 输入：原C函数源码片段（通过位置信息读取）、位置信息（文件、起止行列）、被调用函数清单（若已转：提供已转 Rust 模块/路径；未转：提供原C函数位置信息）\n   - 输入：当前 crate 目录结构（模块树、已存在mod.rs）\n   - 产出：建议落盘目标Rust模块路径、函数签名（summary中输出），并将当前函数进度写入进度JSON\n\n2) 生成实现：\n   - 创建 CodeAgent 作为执行体，上下文包含：目标模块、函数签名、C源码片段、依赖函数信息、crate结构、放置位置建议\n   - 让 CodeAgent 生成/更新对应Rust文件中的函数实现\n\n3) 构建与修复：\n   - 调用 cargo build（或项目构建命令）尝试编译\n   - 若失败：收集错误、相关上下文，创建 CodeAgent 进行修复，迭代直到构建通过（设定失败重试上限，避免死循环）\n\n4) 代码审查与优化：\n   - 创建审查Agent进行代码审查；若summary指出问题，则再次创建 CodeAgent 优化，直至通过\n\n5) 标记与映射：\n   - 将该函数标记为\"已转换\"，记录C符号到Rust符号/模块路径的映射到 symbol_map.json\n\n【产物与状态记录】\n- 进度文件：<root>/.jarvis/c2rust/progress.json（记录当前处理到的函数、状态、建议模块、签名等）\n- 映射文件：<root>/.jarvis/c2rust/symbol_map.json（记录 C 符号 -> Rust 符号/模块路径）\n\n【CLI 参数建议】\n- --root 指定项目根；--llm-group 指定模型组；--resume 续跑；--max-retries 构建修复最大次数；--only 函数过滤；--dry-run 仅规划不落盘\n\n【失败策略】\n- 连续构建失败超过阈值时暂停当前函数并记录错误详情，继续下一个或退出（提供 --max-retries 选项）\n\n【系统集成】\n- 多Agent架构提供整体迁移框架与状态管理\n- 转译子命令提供函数级精确控制与CLI接口\n- 两者共享数据格式与状态文件，支持互操作\n- 都支持断点续跑与错误恢复机制\n\n【设计原则】\n- 渐进迁移：小步快跑，每个单元独立迁移与验证\n- 自动化优先：最大化Agent驱动，最小人工干预\n- 可回退性：每步Git提交确保可追溯与可回退\n- 测试驱动：迁移前后必须通过测试验证\n- 模块化设计：支持独立演进与功能增强\n\n【预期效果】\n- 建立完整的C2Rust多Agent迁移框架\n- 提供函数级精确转译能力\n- 支持自动化、断点续跑与状态管理\n- 确保迁移过程的可重复性和可验证性\n- 实现C/C++到Rust的安全、可控、可追溯的渐进迁移",
  "tags": [
    "jarvis_c2rust",
    "jarvis_multi_agent",
    "c2rust",
    "transpile",
    "multi_agent",
    "architecture",
    "subcommand",
    "migration_system",
    "progressive_transformation",
    "automated_migration",
    "state_management"
  ],
  "type": "project_long_term",
  "merged_from": ["20251017_223816_053477", "20251024_004920_607524"],
  "id": "merged_8e01863d",
  "created_at": "2025-11-12T23:47:43.495945"
}
