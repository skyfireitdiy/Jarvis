{
  "content": "Jarvis C2Rust 准确性优先的优化与流水线增强（综合性规划与实施框架）\n\n【总体目标】\n- 不考虑性能与资源，仅针对\"结果正确/稳健性/可回退\"强化，最小侵入、可度量、可持续收敛\n- 强化输出与解析的严谨性、边界条件处理与提示词约束，避免误判与错误写盘\n- 优先进行小粒度、低风险的变更，按补丁序列逐步应用，可回退\n- 以最小侵入的补丁序列逐步提升转译准确性，每个优先项具备清晰的输入/输出、可回退与验收标准\n\n【优先级框架】\n- P1（立即执行，收益高风险低）：签名预推导与交叉校验、子目录模块声明补齐、提示词与校验一致\n- P2（跟进增强）：双审查器机制（类型/边界一致性审查）、TODO 占位替换策略强化\n- P3（可选、需更多验证）：scanner 准确性增强、断点与进度结构化增强\n\n【当前状态（P1 已完成项）】\n- P1.1: 签名预推导与一致性校验（参数个数、指针 *const/*mut、返回指针）\n- P1.2: 子目录 mod.rs 声明链补齐（逐级 pub mod，顶层由 lib.rs 公开）\n- 规划/生成稳健性：相对/绝对路径归一、禁止 main.rs、确保目标文件存在、实现存在且带函数体校验\n- 构建控制：尊重 --max-retries\n- TODO 替换策略强化：优先完全限定路径、禁止 use 通配\n- 二次审查器：类型/边界一致性；必要时最小修复；进度记录 type_boundary審\n- CLI：transpile 增加 --max-retries、--resume\n\n【核心优化点与改动建议】\n\n1) transpiler.py\n- 签名预推导与一致性校验：基于 symbols.jsonl 的 C 签名推导 Rust 草案，与 LLM 产出比对关键维度（参数个数、指针可变性、返回类型结构）。记录差异并驱动一次最小修复\n- 指针+长度参数配对规则：检测 i 为指针且 i+1 为长度类型的常见模式；Rust 端需成对出现（如 *const u8 + usize 或 &[u8]），缺失时标记 [sig] pointer+len mismatch\n- 函数指针参数保守映射：含(*)时默认保守为原样或 *const/*mut c_void；若 LLM 推断成具体函数类型而不确定，提示并回退为占位\n- todo!(\"symbol\") 占位解析增强：正则支持 todo!\\s*\\(\\s*[\"']{sym}[\"']\\s*\\)，兼容单/双引号与空白变体；两轮扫描（简名、完全限定名）\n- Rust 函数名/签名提取健壮性：主匹配失败时兼容 async fn、extern \"C\" fn 等变体\n- 子目录 mod.rs 声明补齐：在 src/<subdir>/mod.rs 追加/升级 pub mod <child>; 顶层由 lib.rs 统一公开。仅在必要时最小写盘\n- 进度与度量：progress.json 增加 signature_advice、impl_verified、mod_visibility_fixed、metrics.sig_issues/type_issues；在构建修复前后各统计一次（静默更新，少日志）\n- 重试控制：尊重 --max-retries 限制构建修复循环上限，失败回退当前稳定状态\n- 模块路径规范化：生成与引用均使用标准化模块路径，优先完全限定调用，避免 use 通配\n\n2) library_replacer.py\n- \"主库\"字段回退修复：primary_lib = libraries_out[0] if libraries_out else lib_single，避免在仅提供单库字段时落空\n- 禁用库约束：disabled_libraries 注入提示词；LLM 选到禁用库时直接判为不可替代并记录警告\n- 断点恢复（checkpoint/resume）：按输入关键集合构建 checkpoint key，N 步写盘原子替换，完成后按策略清理\n- 提示与替换策略：优先完全限定路径；必要时最小 use；YAML 解析宽松兜底但写盘严格校验\n\n3) cli.py\n- transpile 子命令强化：--resume、--max-retries；构建/修复循环受限，进度文件断点续跑\n- collect 子命令：输出唯一函数名（优先限定名）到指定文件，增强后续上下文质量\n- 测试框架 Agent：生成 .jarvis/c2rust/test.sh（若缺失），识别 make/ctest/meson；无测试则落最小 smoke；运行前置检查与自愈\n- Agent 基础设施：agents/records 与 logs 路径统一创建，记录关键步骤与产物索引\n\n4) scanner/解析增强（规划）\n- CALL_EXPR 覆盖操作符/模板特例、函数指针解析；displayname 清洗避免参数串混入\n- compile_commands 使用增强，失败回退空参数，尽可能保证解析成功不阻塞主流程\n\n5) 文档与一致性\n- __init__.py 与 README：统一描述 symbols.jsonl 为主输入，更新路径规范至 .jarvis/c2rust/*；绝对路径原则\n\n【下一轮（P2 强化与收敛）任务清单】\n1) 签名一致性规则扩充（启发式，最小规则集）\n   - 指针+长度参数配对检查：当 C 形参 i 为指针，且 i+1 为长度（size_t/ssize_t/int/uint32_t/uint64_t 等），若 Rust 第 i 位既非指针也非切片（&[T] 等），或第 i+1 位缺失长度参数，标记 [sig] pointer+len mismatch\n   - 函数指针参数保守映射：对含\"(*)\"的 C 类型，建议 Rust 使用原样类型或 *const c_void/*mut c_void 占位，避免错误推断；出现不匹配时提示 [sig] function pointer mapping\n   - typedef 链的定宽别名识别（已扩充 int*_t 映射，保持原样回退）\n2) 观测与诊断\n   - 为 sig/类型审查增加最小计数器：progress.current.metrics = {sig_issues:n, type_issues:n}\n   - 在 cargo 修复循环前后输出一次统计摘要（不增多余日志，只更新 progress）\n3) 提示词微调\n   - 在实现提示中明确\"指针+长度组合优先保持成对出现；若临时不清晰，至少保留长度参数占位\"\n\n【新增流水线步骤 / Agents】\n- SignatureVerifierAgent：比对 C→Rust 签名差异，生成最小修复建议并回写\n- TypeBoundaryReviewAgent：检查 const/可变性、指针+长度组合、零终止字符串等常见边界；仅一次最小修复\n- ModuleVisibilityAgent：巡检并补齐子目录 mod.rs 与顶层导出\n- BuildFixAgent：cargo build 收集错误上下文，限次修复循环，失败回退\n- ReplacementEvaluator（库替代评估）：带禁用库约束，支持 checkpoint/resume\n- TestHarnessEngineer：生成/修复测试脚本，保障最小 smoke 可运行\n- Collector：收集函数（限定名优先）提升上下文稳定性\n- Auditor/MetricsRecorder：生成 YAML verdict/摘要，进度与统计结构化写入 progress.json\n\n【执行顺序（自动规划）】\n- 先 P1.1（签名预推导与比对）→ P1.2（子目录 mod.rs 声明补齐）\n- 再 P2.4（类型/边界审查器）→ P2.5（TODO 替换提示策略强化）\n- 最后 P3.6/P3.7 按需评估投入\n\n【补丁应用优先级（按风险与收益）】\nA) library_replacer 主库字段修复（低风险，高准确性收益）\nB) __init__.py 文档更新（低风险，提升一致性）\nC) transpiler todo 占位正则匹配增强（中低风险，中等收益）\nD) 签名预推导/一致性校验 + metrics 计数器\nE) CLI: transpile 增 --resume/--max-retries；collect 子命令；测试框架 Agent 子命令\nF) 后续规划上下文增强（需更多验证，暂不立即改）\n\n【验收与回退原则】\n- 写盘仅限必要区域（末尾追加或小范围补丁），原子替换，失败回退\n- 解析失败不阻塞主流程；记录 issue 列表与计数，后续收敛\n- 每一步可独立提交，[JARVIS-C2RUST] 前缀；--max-retries 上限保护\n- 影响评估：A/B/C 为局部改动，不影响接口与既有行为（除更准确的字段写出与占位命中率提升），可随时回退\n- 规则仅发出问题列表并驱动一次最小修复；解析失败不阻塞（静默通过）\n- 任何写盘变更保持最小；失败回退现有稳定路径（构建修复/审查循环）\n- 单次改动不引入构建不稳定；若构建失败，迭代修复不超过 max_retries\n- 记录每步结果到 progress.json（新增字段：signature_advice、impl_verified、mod_visibility_fixed）\n\n【设计原则】\n- 最小变更优先：默认守旧策略，无法解析时不阻塞主流程\n- 渐进增强：每个功能点可独立启用/禁用，不影响现有稳定路径\n- 可度量收敛：通过 metrics 计数器跟踪改进效果\n- 可回退机制：所有新增写盘均在目标文件末尾或局部升级，不覆盖业务代码；保留回退可删除的注入点\n- 面向\"准确性\"，默认守旧与最小变更，所有新增能力均可被跳过/回退，不破坏现有稳定路径\n\n【下一步行动计划】\n- 先应用 A：修复 library_replacer 替代映射 \"library\" 字段的回退逻辑\n- 后续按优先级推进 B 与 C；D 进入设计评估阶段\n- 建立完整的测试验证流程，确保每个补丁的准确性提升",
  "tags": [
    "jarvis_c2rust",
    "accuracy",
    "optimization_principle",
    "pipeline",
    "agents",
    "planning",
    "roadmap",
    "quality_assurance",
    "incremental_improvement",
    "error_handling",
    "minimal_change",
    "transpilation",
    "systematic_enhancement",
    "robustness"
  ],
  "type": "project_long_term",
  "merged_from": ["merged_67463fba", "merged_c9c45aa6"],
  "id": "merged_21725a5f",
  "created_at": "2025-11-12T23:38:07.990372"
}
