{
  "content": "Jarvis C2Rust 渐进迁移系统：测试框架生成、转译子命令与绝对路径规范\n\n【总体目标】\n构建完整的 C/C++ -> Rust 渐进迁移系统，包含测试框架生成、函数转译能力与路径规范化，支持自动化、断点续跑与状态管理。\n\n【Step 1：测试框架生成完成】\n- CLI 命令：python -m jarvis.jarvis_c2rust.cli --root .\n- 功能目标：为 C/C++ 项目生成测试框架的 Agent，负责为已有的 C/C++ 代码创建测试框架\n- 最终在 .jarvis/c2rust/test.sh 生成可执行测试脚本，运行该脚本可执行当前 C 项目的所有测试\n- 优先适配通用构建/测试入口：make test/check, ctest, meson test 等；若不存在则提供可扩展的占位实现\n\n【检测结果】\n- build_system: unknown（未检测到CMake/Meson/Autotools/Make/Bazel）\n- tests_found: false（无显式测试，已搭建smoke test）\n\n【test.sh 逻辑设计】\n- 构建阶段：若无法识别构建系统则跳过，仅输出提示\n- 测试阶段：无显式测试时执行smoke检查（构建成功即通过）\n- 扩展性：为后续添加具体测试用例预留接口\n\n【路径规范化要求】\n- 所有生成的脚本必须使用绝对路径，不使用相对路径\n- 脚本应在开头解析自身目录与仓库根为绝对路径：\n  script_dir=\"$(cd \"$(dirname \"$0\")\" && pwd)\"\n  repo_root=\"$(cd \"$script_dir/../..\" && pwd)\"\n- 使用绝对路径引用 .jarvis/c2rust/c2rust_migration 与 .jarvis/c2rust/rust_bridge 等目录\n- 保证在任意工作目录下可幂等执行\n\n【转译子命令架构】\n- 位置与命名：在 src/jarvis/jarvis_c2rust 下新增模块 transpiler.py，在 cli.py 中新增子命令 transpile，与现有 scan/plan 并列\n\n【数据输入】\n- 依赖 scanner 产物：<root>/.jarvis/c2rust/functions.jsonl（含函数位置信息、调用关系、拓扑顺序）与 types.jsonl（如有）\n- 源码根目录：默认当前工作目录或从扫描记录推断\n\n【转译流程（按 scanner 生成的函数顺序）】\n1) 为每个待转函数创建一个 LLM Agent（模块选择与签名生成Agent）：\n   - 输入：原C函数源码片段（通过位置信息读取）、位置信息（文件、起止行列）、被调用函数清单（若已转：提供已转 Rust 模块/路径；未转：提供原C函数位置信息）\n   - 输入：当前 crate 目录结构（模块树、已存在mod.rs）\n   - 产出：建议落盘目标Rust模块路径、函数签名（summary中输出），并将当前函数进度写入进度JSON\n\n2) 生成实现：\n   - 创建 CodeAgent 作为执行体，上下文包含：目标模块、函数签名、C源码片段、依赖函数信息、crate结构、放置位置建议\n   - 让 CodeAgent 生成/更新对应Rust文件中的函数实现\n\n3) 构建与修复：\n   - 调用 cargo build（或项目构建命令）尝试编译\n   - 若失败：收集错误、相关上下文，创建 CodeAgent 进行修复，迭代直到构建通过（设定失败重试上限，避免死循环）\n\n4) 代码审查与优化：\n   - 创建审查Agent进行代码审查；若summary指出问题，则再次创建 CodeAgent 优化，直至通过\n\n5) 标记与映射：\n   - 将该函数标记为\"已转换\"，记录C符号到Rust符号/模块路径的映射到 symbol_map.json\n\n【产物与状态记录】\n- 进度文件：<root>/.jarvis/c2rust/progress.json（记录当前处理到的函数、状态、建议模块、签名等）\n- 映射文件：<root>/.jarvis/c2rust/symbol_map.json（记录 C 符号 -> Rust 符号/模块路径）\n\n【CLI 参数建议】\n- --root 指定项目根；--llm-group 指定模型组；--resume 续跑；--max-retries 构建修复最大次数；--only 函数过滤；--dry-run 仅规划不落盘\n\n【失败策略】\n- 连续构建失败超过阈值时暂停当前函数并记录错误详情，继续下一个或退出（提供 --max-retries 选项）\n\n【进度管理】\n- 断点续跑：进度写入 .jarvis/c2rust/progress.json（step=1, status=prepared）\n- 版本控制：当前源码改动已存在或与HEAD一致，git未检测到差异；后续步骤产生变更时统一按 [JARVIS-C2RUST] 规范提交\n\n【设计原则】\n- 兼容性优先：优先适配主流构建系统（CMake/Meson/Autotools/Make/Bazel）\n- 渐进增强：从smoke test开始，逐步完善具体测试用例\n- 最小侵入：不修改现有构建配置，仅生成独立测试脚本\n- 可扩展性：为复杂测试场景预留扩展点\n- 路径统一：所有脚本使用绝对路径确保幂等执行\n- 自动化优先：最大化Agent驱动，最小人工干预\n- 可回退性：每步Git提交确保可追溯与可回退\n- 测试驱动：迁移前后必须通过测试验证\n\n【预期效果】\n- 为 C2Rust 转译前后的代码提供统一测试框架\n- 支持构建验证与基本功能检查\n- 为后续 Rust 代码测试迁移提供基线参考\n- 保障转译过程中功能等价性验证\n- 实现完整的函数级转译能力与状态管理\n- 建立规范化的路径引用体系确保脚本可移植性",
  "tags": [
    "jarvis_c2rust",
    "c2rust",
    "test_script",
    "transpile",
    "agent",
    "cli",
    "absolute_paths",
    "scripts",
    "build_integration",
    "smoke_test",
    "migration_system",
    "automated_migration",
    "path_normalization",
    "pipeline_architecture"
  ],
  "type": "project_long_term",
  "merged_from": [
    "merged_38cd2c91",
    "20251024_004920_607524",
    "20251019_235518_028421"
  ],
  "id": "merged_eca66867",
  "created_at": "2025-11-12T23:43:57.993643"
}
