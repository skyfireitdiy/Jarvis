{
  "content": "Jarvis 多Agent系统设计：C2Rust迁移架构、配置增强与逻辑修复\n\n【C2Rust多Agent系统设计（2025-10-17）】\n\n【总体目标】\n在 /home/skyfire/code/Jarvis/builtin/multi_agent 设计\"C/C++ -> Rust\"转换多Agent系统，实现渐进式代码迁移与测试验证。\n\n【核心流程】\n1) 识别当前代码的构建框架与流程，产出一键编译脚本\n2) 识别/构建测试用例运行流程，产出测试脚本（若缺失则创建测试框架与空用例）\n3) 建立Rust静态库（staticlib）工程并与现有工程链接，产出运行测试用例脚本\n4) 逐步发现C/C++单元，补充用例并保证通过；随后以Rust实现替换，并在未转换依赖处使用extern/unsafe调用\n5) 用例通过后优化Rust实现，减少不必要的unsafe，保持用例通过\n6) 迭代直到全量切换到Rust\n\n【设计要求】\n- 除主Agent外尽量无状态或使用Sub Agent\n- 支持断点续转：通过关键文件（如进度状态文件）识别转换进度\n- 遵循项目现有multi_agent风格（优先YAML编排），最小侵入、可回滚\n\n【预期产物与路径】\n- 编排：builtin/multi_agent/c2rust_migration.yaml（主编排）\n- 进度文件：builtin/multi_agent/c2rust_state.json（断点续转状态）\n- 脚本：scripts/build.sh、scripts/test.sh、scripts/run_tests_with_rust.sh\n- Rust桥接工程：rust_bridge/（Cargo.toml、build.rs、src/lib.rs，crate-type为staticlib）\n\n【多Agent配置增强（2025-10-15）】\n\n【新增配置】\n- 配置键：JARVIS_MULTI_AGENT_SUMMARY_ON_SEND（bool，默认true）\n- 动机：控制多智能体在发送消息时是否生成上下文摘要，默认启用以增强协作交接的清晰性；可关闭以减少模型调用成本\n\n【实施方案】\n1) 在 jarvis_utils/config.py 增加接口 is_multi_agent_summary_on_send() -> bool，默认 True\n2) 在 jarvis_multi_agent/__init__.py 的 MultiAgent.run 中，生成摘要逻辑前读取该配置，若为 False 则跳过模型摘要生成（summary_text=\"\"）\n3) 在 jarvis_data/config_schema.json 增加该配置项，type boolean，default true，并补充说明\n4) 在 docs/jarvis_book/9.附录.md 的配置表中新增该项并说明用途与默认值\n\n【影响评估】\n- 仅新增可选配置与条件逻辑，不改变默认行为\n- 关闭时减少一次直呼模型的成本\n- 对现有功能无破坏性\n\n【多Agent逻辑修复（2025-10-15）】\n\n【问题发现】\n在 src/jarvis/jarvis_multi_agent/__init__.py 的 MultiAgent.run 中，clear_after_send_message 分支调用了 agent.clear_history()，但此时 agent 变量已被重新赋值为接收方智能体（to_agent）。导致清空的是接收方历史，而非发送方历史，逻辑错误。\n\n【影响】\n- 发送消息后的历史清除无法保证清除实际的发送方会话历史\n- 违背\"清除发送方历史\"的设计意图\n- 可能造成上下文污染或丢失错误对象的历史\n\n【修复方案】\n- 在将 agent 重新赋值为接收方之前，保留发送方引用（sender_agent = agent）\n- 在 clear_after_send_message 分支中调用 sender_agent.clear_history()\n- 将存在的 if agent: 判断改为 if sender_agent:\n- 保持提示文案中使用 last_agent_name\n\n【系统集成原则】\n- 渐进设计：C2Rust系统采用分阶段迁移策略\n- 配置灵活：支持摘要生成的开启与关闭\n- 逻辑正确：修复历史清除的逻辑错误\n- 最小侵入：所有变更保持向后兼容\n- 可回滚性：支持配置回退与架构恢复\n\n【预期效果】\n- 建立完整的C2Rust多Agent迁移框架\n- 提供可配置的摘要生成机制\n- 修复多Agent系统的历史管理逻辑\n- 确保系统稳定性和功能完整性",
  "tags": [
    "jarvis_multi_agent",
    "c2rust",
    "multi_agent",
    "configuration",
    "bug_fix",
    "summary_policy",
    "clear_history",
    "migration_system",
    "system_design",
    "logic_correction",
    "progressive_transformation"
  ],
  "type": "project_long_term",
  "merged_from": [
    "20251015_001059_405204",
    "20251017_223816_053477",
    "20251015_201325_894325"
  ],
  "id": "merged_57c747fc",
  "created_at": "2025-11-12T23:47:05.443640"
}
