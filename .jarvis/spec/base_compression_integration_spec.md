# Base平台压缩策略集成规范

## 功能概述

将 `run_loop.py` 中的多种压缩策略（自适应压缩、滑动窗口压缩、重要性评分压缩等）集成到 `base.py` 中的自动总结功能，增强BasePlatform的上下文管理能力，使其在触发自动总结时能够选择最合适的压缩策略。

## 接口定义

### 方法签名

```python
def apply_compression_strategy(self, strategy_type: str = "adaptive") -> bool:
    """应用指定的压缩策略
    
    参数:
        strategy_type: 压缩策略类型，可选值包括:
            - "adaptive": 自适应压缩
            - "sliding_window": 滑动窗口压缩
            - "importance_scoring": 重要性评分压缩
            - "key_event_extraction": 关键事件提取压缩
            - "incremental_summarization": 增量摘要压缩
            
    返回:
        bool: 压缩是否成功
    """
```

### 增强的自动总结检查方法

```python
def _check_and_apply_compression(self) -> bool:
    """检查是否需要压缩，并应用最合适的压缩策略
    
    返回:
        bool: 是否成功应用了压缩
    """
```

## 输入输出说明

### 输入参数

- `strategy_type`: 压缩策略类型字符串，必须是预定义的策略类型之一
- Agent实例引用（用于调用压缩方法）

### 返回值说明

- 布尔值表示压缩操作是否成功
- 不抛出异常，压缩失败时返回False

## 功能行为

### 正常情况

1. 当token使用率超过75%或对话轮次超过阈值时，触发压缩检查
2. 根据Agent可用的压缩方法，应用最适合的压缩策略
3. 压缩成功后更新上下文并继续对话流程

### 策略选择逻辑

1. 首选自适应压缩策略，根据任务类型自动选择最适合的压缩方法
2. 如果自适应压缩失败或不可用，按优先级尝试：滑动窗口压缩 → 重要性评分压缩 → 关键事件提取压缩 → 增量摘要压缩
3. 所有策略都失败时，回退到原始的总结和清空历史方式

### 边界情况

- 当Agent没有压缩方法可用时，使用原始的总结方式
- 当压缩后token仍然不足时，继续使用trim_messages()方法
- 当压缩过程中出现异常时，不影响主对话流程

### 异常情况

- 所有异常被捕获并记录日志，不中断主流程
- 压缩失败时返回False，由调用方决定后续处理

## 验收标准

1. **功能完整性**：所有run_loop.py中的压缩策略都可在base.py中调用
2. **兼容性**：原有自动总结逻辑不受影响，保持向后兼容
3. **策略优先级**：按规范的优先级顺序尝试压缩策略
4. **异常处理**：压缩过程中的异常被妥善处理
5. **性能要求**：压缩操作不会显著影响对话响应时间
6. **集成验证**：在_base.py的自动总结检查中能正确调用新压缩策略
7. **无侵入性**：不修改run_loop.py中的任何现有逻辑
8. **配置可控**：可通过配置选择不同的压缩策略