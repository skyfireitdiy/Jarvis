<!-- markdownlint-disable MD029 -->

# 版本发布规则

## 规则简介

本规则用于规范Jarvis项目的ReleaseNote更新流程，确保ReleaseNote的格式一致性以及代码变更的准确性。

**本规则仅支持单一模式**：

- **仅更新ReleaseNote**：只更新ReleaseNote.md文件，**禁止**创建git tag、**禁止**push代码、**禁止**修改项目版本号（如`__init__.py`、`setup.py`、`pyproject.toml`等文件）

## 你必须遵守的原则

### 1. 语义化版本号

**要求说明：**

- **必须**：使用语义化版本格式 `vX.Y.Z`（如 `v1.2.0`）
- **必须**：版本号格式为 `v` + `主版本号` + `.` + `次版本号` + `.` + `修订号`
- **禁止**：跳过版本号或使用非标准格式（如 `v1.2`、`1.2.0`）

**版本号含义：**

- **主版本号（X）**：不兼容的API修改或破坏性变更
- **次版本号（Y）**：向下兼容的功能性新增
- **修订号（Z）**：向下兼容的问题修正

### 2. 代码变更获取准确性

**要求说明：**

- **必须**：使用 `git diff` 获取真实的代码变更
- **禁止**：使用 `git log` 或 commit 信息（可能不准确）
- **必须**：变更范围从最新tag到HEAD

**原因：** commit 信息可能存在不准确、不完整的情况，而 `git diff` 提供的是真实的代码差异。

### 3. ReleaseNote格式一致性

**要求说明：**

- **必须**：保持与现有ReleaseNote.md相同的格式结构
- **必须**：在文件头部插入新版本信息
- **必须**：使用统一的分类（新功能、修复、优化、文档等）
- **必须**：遵循用户视角原则（见下方详细说明）

### 3.1 用户视角原则（核心）

**重要说明**：ReleaseNote 是给用户看的，不是给开发者看的。

**禁止内容**（技术细节）：

- **禁止**：代码行数（如 +583行，-417行）
- **禁止**：文件路径（如 src/jarvis/jarvis_sec/cli.py）
- **禁止**：方法名（如 \_save_agent_state()）
- **禁止**：实现方式细节（如 在\_list_session_files()方法中添加过滤逻辑）

**必须内容**（用户价值）：

- **必须**：功能带来的好处（如 配置更便捷、使用更简化）
- **必须**：用户体验改进（如 中断恢复、快速提交）
- **必须**：问题修复说明（如 修复了什么用户遇到的问题）

**写作公式**：

1. **功能描述**：功能名称 + 价值 + 使用场景
2. **问题修复**：用户遇到的问题 + 修复效果
3. **优化改进**：改进点 + 用户价值

### 3.2 格式规范

**图标使用**：

- 新功能：🎯（与历史版本保持一致）
- 修复：🔧
- 优化：🎯
- 文档：📖
- 分类标题：🚀📌🔧📚🗑️

**子条目格式**：

```markdown
- **🎯 功能名称**
  - **价值标签**：功能带来的好处
  - **场景标签**：什么时候用到、怎么用
```

**内容组织**：

- 每个条目控制在 2-3 个子条目
- 突出核心价值，避免冗长描述
- 使用简洁的标签式描述

## 你必须执行的操作

### 操作1：获取最新版本号

> ⚠️ **注意**：此步骤用于获取基准版本号，以便获取从该版本到当前的代码变更。

**执行步骤：**

1. 执行命令获取最新tag：

```bash
git describe --tags --abbrev=0
```

2. 如果没有tag，使用默认版本 `v1.0.0`

**预期输出：** 最新版本号（如 `v1.1.1`）

### 操作2：获取当前日期

> ⚠️ **注意**：此步骤用于生成ReleaseNote中的日期，必须执行。

**执行步骤：**

1. 执行命令获取当前日期：

```bash
date +%Y-%m-%d
```

**预期输出：** 日期字符串（如 `2026-01-12`）

### 操作3：检查wechat.png文件修改时间

> ⚠️ **重要**：此检查必须在更新ReleaseNote前完成。如果wechat.png修改时间超过7天，必须先更新该文件，否则拒绝更新。

**执行步骤：**

1. 检查文件是否存在：

```bash
ls -lh docs/images/wechat.png
```

2. 获取文件修改时间（Unix时间戳）：

```bash
stat -c %Y docs/images/wechat.png
```

3. 获取当前时间戳：

```bash
date +%s
```

4. 计算文件修改天数：

```python
# 使用Python计算天数差
import time

file_mtime = int(<文件修改时间戳>)
current_time = int(<当前时间戳>)
days_diff = (current_time - file_mtime) // 86400
print(f"wechat.png修改天数: {days_diff}天")
```

5. 判断检查结果：
   - 如果 `days_diff > 7`：**拒绝更新**，提示用户：`⚠️ wechat.png文件已超过{days_diff}天未更新，请先更新该文件后再进行ReleaseNote更新`
   - 如果 `days_diff <= 7`：继续执行后续操作

**预期输出：**

- 文件存在且修改时间未超过7天：继续流程
- 文件不存在或修改时间超过7天：停止流程并提示更新

### 操作4：运行pytest测试

> ⚠️ **重要**：此步骤确保所有测试用例通过，否则禁止发布。必须在获取代码变更前完成。

**执行步骤：**

1. 执行pytest命令：

```bash
pytest -v
```

2. 检查测试结果：
   - 如果测试全部通过（exit code为0）：继续执行后续操作
   - 如果有测试失败（exit code非0）：**禁止发布**，提示用户：`⚠️ 测试失败，请修复失败的测试用例后再进行发布`

3. （可选）查看详细测试报告：

```bash
pytest -v --tb=short
```

**注意事项：**

- 必须在项目根目录执行pytest命令
- 如果有特定测试目录，可以指定路径（如 `pytest tests/`）
- 测试失败时禁止跳过此步骤继续发布

**预期输出：**

- 测试全部通过：继续流程
- 测试失败：停止流程并禁止发布

### 操作5：获取代码变更

**执行步骤：**

1. 首先获取变更统计信息：

```bash
git diff <latest_tag> HEAD --stat
```

2. 然后获取完整的代码差异：

```bash
git diff <latest_tag> HEAD
```

**注意事项：**

- `<latest_tag>` 替换为操作1获取的版本号
- 如果输出过大，可以限制行数（如 `| head -n 500`）

### 操作6：学习ReleaseNote格式

**执行步骤：**

1. 读取ReleaseNote.md前200行：

```bash
head -n 200 {{ git_root_dir }}/ReleaseNote.md
```

2. 参考历史版本格式（建议查看 v1.2.6 之前的版本）：
   - 标题格式：`### Release Note - v{version} {date}`
   - 分类结构：新功能、修复、优化与重构、文档更新等
   - 图标使用：🚀、📌、🔧、📚、🧪、🗑️等
   - 子分类格式：`#### **分类名称**`
   - 条目格式：`- **🎯 标题**` + `- **标签**：内容`

3. **特别注意**：参考历史版本时，重点关注用户视角和内容简洁性，不要包含技术细节

### 操作7：生成新版本ReleaseNote

**执行步骤：**

1. **计算新版本号**（根据用户提供的版本类型）：

```python
# 版本号计算逻辑
major, minor, patch = map(int, latest_version[1:].split('.'))

if version_type == 'major':
    new_version = f"v{major + 1}.0.0"
elif version_type == 'minor':
    new_version = f"v{major}.{minor + 1}.0"
elif version_type == 'patch':
    new_version = f"v{major}.{minor}.{patch + 1}"
else:
    raise ValueError("版本类型必须是 major、minor 或 patch")
```

2. **生成新版本内容**：

```markdown
### Release Note - {new_version} {date}

#### **🚀 新功能**

#### **📌 修复**

#### **🔧 优化与重构**

#### **📚 文档更新**

---
```

3. **在ReleaseNote.md头部插入新版本内容**：
   - 读取现有ReleaseNote.md内容
   - 在文件开头插入新版本内容
   - 保持原有格式和分隔符

**注意事项：**

- 必须在用户确认版本类型后再执行插入操作
- 插入位置为文件第一行之前
- 保持原有的 `---` 分隔符格式

> ⚠️ **重要**：本规则仅支持更新ReleaseNote，**禁止**执行以下操作：
>
> - **禁止**创建git tag
> - **禁止**push代码到远程仓库
> - **禁止**修改项目版本号（如`__init__.py`、`setup.py`等文件）
> - **禁止**执行任何与git相关的推送操作

## 检查清单

在完成任务后，你必须确认：

- [ ] 最新版本号获取成功（格式正确：vX.Y.Z）
- [ ] 日期获取成功（格式正确：YYYY-MM-DD）
- [ ] wechat.png修改时间检查通过（未超过7天）
- [ ] pytest测试全部通过（无失败用例）
- [ ] 代码变更已获取（使用了git diff而非git log）
- [ ] ReleaseNote格式已学习（了解分类和图标使用）
- [ ] 新版本号计算正确（根据版本类型）
- [ ] 新版本内容已插入到ReleaseNote.md头部
- [ ] ReleaseNote.md文件格式完整（无语法错误）

## 常见问题

### Q1：本规则的使用场景是什么？

本规则仅用于更新ReleaseNote.md文件，适用于以下场景：

- 阶段性文档整理
- 预览ReleaseNote内容
- 在没有正式发布需求时更新版本记录

**重要提醒**：本规则不支持完整的版本发布流程（如创建git tag、更新项目版本号、push代码等）。

### Q2：如果没有git tag怎么办？

使用默认版本号 `v1.0.0` 作为基准版本。

### Q3：如何确定版本类型（major/minor/patch）？

必须询问用户确认版本类型，不能自行推断。

### Q4：是否需要更新版本号？

否。本规则仅支持更新ReleaseNote.md文件，**禁止**执行以下操作：

**禁止事项清单：**

- **禁止**修改项目中的版本号（如`__init__.py`、`setup.py`、`pyproject.toml`等文件）
- **禁止**创建git tag
- **禁止**push代码到远程仓库
- **禁止**执行任何与git相关的推送操作

**允许事项：**

- ✅ 仅更新ReleaseNote.md文件内容
- ✅ 在ReleaseNote.md头部插入新版本说明
- ✅ 添加代码变更的详细描述

### Q5：ReleaseNote内容如何生成？

根据操作4获取的代码变更，结合操作5学习的格式，人工分析并生成ReleaseNote内容。

**关键要点**：

1. 从代码变更中提取**用户价值**，而非技术细节
2. 使用**用户视角**重写功能描述（参考 3.1 节）
3. 每个条目控制在 2-3 个子条目，突出核心价值
4. 参考历史版本格式，保持风格一致

### Q6：为什么要检查wechat.png文件的修改时间？

为确保项目宣传材料的时效性，要求 `docs/images/wechat.png` 文件必须在7天内更新过。如果文件修改时间超过7天，必须先更新该文件（如截图新的二维码、更新联系信息等），否则拒绝更新ReleaseNote。

## 相关资源

- ReleaseNote模板：`{{ git_root_dir }}/ReleaseNote.md`
- Git命令参考：`git diff --help`
- 语义化版本规范：<https://semver.org/lang/zh-CN/>
