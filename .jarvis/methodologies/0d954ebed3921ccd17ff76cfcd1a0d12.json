{
  "problem_type": "tmux_panel_auto_exit",
  "content": "# tmux Panel 自动退出问题诊断与修复方法论\n\n## 问题重述\n在 jarvis 项目中，当使用 jcad/jvsd 等命令在 tmux 中执行任务时，任务完成后 panel 自动退出，无法保持会话状态。\n\n## 问题根本原因\njarvis 项目使用 `shell_fallback` 和 `stay_in_session_after_exit` 两个参数控制命令执行后的行为：\n- `stay_in_session_after_exit`: 命令执行结束后是否保持会话活动\n- `shell_fallback`: 命令执行结束后是否启动 shell 作为 fallback（True 表示启动 shell，False 表示不启动 shell）\n\n问题出现的原因：某些创建 tmux session 的代码路径没有正确处理这两个参数，导致命令执行完后没有启动 shell，pane 自动退出。\n\n## 诊断流程\n\n1. **确认问题现象**\n   - 命令执行完成后 tmux panel 自动退出\n   - 用户期望 panel 保持打开状态\n\n2. **定位相关代码**\n   - 查找调用 dispatch_command_to_panel 的代码（如 jcad_cli.py, jvsd_cli.py）\n   - 检查调用时传递的 shell_fallback 参数值\n   - 确认是否设置为 True\n\n3. **分析 tmux_wrapper.py 的实现**\n   - 检查 dispatch_command_to_panel 函数（第 1099 行开始）\n   - 分析两个执行路径：\n     a) 有现有 session：调用 create_panel 函数\n     b) 无现有 session：调用 find_or_create_jarvis_session 函数\n\n4. **验证参数传递链**\n   - create_panel 函数：检查第 721-722 行是否正确处理 shell_fallback\n   - dispatch_command_to_panel 的无现有 session 分支：检查是否处理了 shell_fallback\n\n## 修复方案\n\n### 场景1：create_panel 函数未处理 shell_fallback\n**位置**：tmux_wrapper.py 第 658-837 行\n\n**修复方法**：\n确保第 721-722 行的代码逻辑为：\n```python\nif stay_in_session_after_exit and shell_fallback:\n    command += f'; exec \"{user_shell}\"'\n```\n\n### 场景2：dispatch_command_to_panel 创建新 session 时未处理 shell_fallback\n**位置**：tmux_wrapper.py 第 1173-1183 行\n\n**修复方法**：\n在调用 find_or_create_jarvis_session 之前，根据参数修改命令字符串：\n```python\ncommand_to_run = shell_command\nif stay_in_session_after_exit and shell_fallback:\n    user_shell = os.environ.get(\"SHELL\", \"/bin/sh\")\n    command_to_run += f'; exec \"{user_shell}\"'\n\nnew_session = find_or_create_jarvis_session(\n    force_create=True, initial_command=command_to_run\n)\n```\n\n### 场景3：调用方传递了错误的 shell_fallback 值\n**位置**：jcad_cli.py, jvsd_cli.py 等调用代码\n\n**修复方法**：\n确保调用 dispatch_command_to_panel 时传递 shell_fallback=True：\n```python\ndispatch_command_to_panel(\n    command,\n    stay_in_session_after_exit=True,\n    shell_fallback=True,  # 关键参数\n)\n```\n\n## 验证步骤\n\n1. **代码审查**\n   - 使用 read_code 工具读取相关代码段\n   - 验证 shell_fallback 参数在所有执行路径中都被正确处理\n   - 确认逻辑：`if stay_in_session_after_exit and shell_fallback:`\n\n2. **功能测试**\n   - 执行 jcad 命令\n   - 等待任务完成\n   - 验证 tmux panel 是否保持打开状态（显示 shell 提示符）\n\n3. **边界测试**\n   - 测试在有现有 session 和无现有 session 两种情况下的行为\n   - 验证 shell_fallback=False 时是否正确退出\n\n## 注意事项\n\n1. **参数一致性**：确保所有创建 tmux session 的函数都一致地处理 shell_fallback 参数\n\n2. **命令字符串安全**：使用 shlex.quote 转义 shell 路径，避免注入风险\n\n3. **影响范围**：\n   - 只修改 dispatch_command_to_panel 函数的无现有 session 分支\n   - 不影响使用现有 session 的分支\n   - 不影响其他命令的行为\n\n4. **历史参考**：\n   - 记忆ID: 20260114_004924_046737 - 之前修复 jcad/jvsd 的类似问题\n   - 记忆ID: 20260108_224417_780640 - shell_fallback 参数设计的代码审查案例\n\n## 相关文件\n\n- `src/jarvis/jarvis_utils/tmux_wrapper.py` - tmux 封装核心模块\n- `src/jarvis/jarvis_code_agent/jcad_cli.py` - jcad 命令入口\n- `src/jarvis/jarvis_agent/jvsd_cli.py` - jvsd 命令入口",
  "scope": "project"
}
