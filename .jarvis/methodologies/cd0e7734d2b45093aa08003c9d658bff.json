{
  "problem_type": "数字孪生组件LLM集成",
  "content": "# 数字孪生组件LLM集成方法论\n\n## 规则简介\n\n本方法论提供了为Jarvis数字孪生系统的智能增强组件添加LLM推理能力的标准化流程。经过9个组件的实践验证，确保代码质量、向后兼容性和优雅降级。\n\n**适用范围**：NeedInferrer、TimingJudge、PreferenceLearner、ContinuousLearningManager等智能增强组件\n\n## 你必须遵守的原则\n\n### 原则1：保持向后兼容\n\n**要求说明：**\n\n- **必须**：llm_client参数必须为Optional[Any]类型，默认值为None\n- **必须**：LLM不可用时，组件必须保持原有功能（规则/模式匹配）\n- **禁止**：不能删除或修改现有的规则/模式匹配逻辑\n- **禁止**：不能让LLM调用阻塞主流程\n\n### 原则2：LLM实例隔离\n\n**要求说明：**\n\n- **必须**：每个组件必须使用独立的LLM实例\n- **必须**：通过registry.get_cheap_platform()创建LLM实例\n- **禁止**：多个组件共享同一个LLM实例\n\n### 原则3：无状态调用\n\n**要求说明：**\n\n- **必须**：使用complete()方法进行无状态LLM调用\n- **必须**：每次调用都提供完整的上下文信息\n- **禁止**：使用有状态的会话式调用\n\n### 原则4：优雅降级\n\n**要求说明：**\n\n- **必须**：所有LLM调用必须包裹在try-except中\n- **必须**：LLM失败时自动降级到规则模式\n- **必须**：添加详细的异常处理和日志\n\n### 原则5：过程可见\n\n**要求说明：**\n\n- **必须**：添加过程打印，让用户感知LLM在工作\n- **必须**：打印格式：🎯 组件名: 结果 (模式: LLM/规则)\n- **建议**：使用PrettyOutput.auto_print而非print\n\n## 你必须执行的操作\n\n### 阶段1：组件分析\n\n1. **读取组件代码**：使用read_code工具读取目标组件的类定义，重点关注__init__方法和核心推理方法，识别现有的规则/模式匹配逻辑\n\n2. **识别子组件**（如ContinuousLearningManager）：列出所有子组件，检查子组件的__init__方法是否支持llm_client参数，如不支持，需先为子组件添加llm_client参数\n\n### 阶段2：添加LLM客户端\n\n1. **修改__init__方法**：添加llm_client: Optional[Any] = None参数，保存为self._llm_client\n\n2. **为管理器组件传递LLM**（如ContinuousLearningManager）：如果提供了llm_client且没有提供子组件，创建带llm_client的子组件；否则使用默认创建\n\n### 阶段3：实现LLM推理方法\n\n1. **创建_llm_infer_xxx方法**：检查llm_client是否存在，设计结构化prompt要求JSON返回，使用complete()方法进行无状态调用，解析JSON响应并构建结果，捕获异常返回None\n\n2. **设计LLM Prompt模板**：明确角色定位，提供清晰的输入示例，要求JSON格式返回，包含必要的字段说明，要求仅返回JSON不要包含其他文字\n\n### 阶段4：集成LLM推理\n\n1. **修改主推理方法**：优先尝试LLM推理，LLM失败时降级到规则推理，添加过程打印\n\n2. **处理类型安全**：LLM模式和规则模式使用不同变量名，显式标注类型，返回类型使用Optional[Dict[str, Any]]\n\n### 阶段5：验证测试\n\n1. **运行类型检查**：使用mypy检查\n\n2. **运行代码风格检查**：使用ruff检查\n\n3. **验证向后兼容性**：确保不提供llm_client时组件正常工作，确保LLM失败时自动降级到规则模式\n\n## 实践指导\n\n### Prompt设计要点\n\n**情绪识别组件示例**：要求返回emotion_type、confidence、reasoning字段\n\n**需求推理组件示例**：要求返回implicit_need、confidence、reasoning、inference_chain字段\n\n### 过程打印格式规范\n\n- 情绪识别：🎭 情绪识别: {emotion_type} (置信度: {confidence})\n- 需求推理：📚 需求推理: {count}个结果 (模式: {mode})\n- 时机判断：⏰ 时机判断: 用户状态={state}, 紧急度={urgency} (模式: {mode})\n- 偏好学习：👤 偏好学习: 代码风格={style}, 交互风格={interaction} (模式: {mode})\n- 持续学习：🧠 持续学习: 知识+{k}, 技能+{s}, 经验+{e} (模式: {mode})\n\n### 常见错误\n\n**错误1：类型冲突** - LLM和规则模式使用相同变量名导致类型不匹配\n\n**错误2：未使用的异常变量** - 触发ruff F841错误\n\n**错误3：JSON解析失败** - LLM可能返回多余文本导致解析失败，使用正则提取JSON\n\n## 检查清单\n\n完成LLM集成后，请确认：__init__方法添加了llm_client参数，保存为self._llm_client，实现了_llm_infer_xxx方法，主推理方法优先使用LLM失败时降级到规则模式，添加了过程打印，所有LLM调用都包裹在try-except中，使用complete()方法进行无状态调用，代码通过mypy和ruff检查，验证向后兼容性和降级策略\n\n## 参考组件\n\n已完成LLM集成的9个组件可作为参考：EmotionRecognizer、NeedPredictor、PersonalityAdapter、ProactiveAssistant、AmbiguityResolver、NeedInferrer、TimingJudge、PreferenceLearner、ContinuousLearningManager",
  "scope": "project"
}
