# -*- coding: utf-8 -*-
"""
C2Rust åŠŸèƒ½å¯¹é½éªŒè¯æ¨¡å—

ç›®æ ‡ï¼š
- æ£€æŸ¥ c2rust è½¬è¯‘æ˜¯å¦å®Œæˆ
- åˆ†æè½¬è¯‘åçš„ Rust ä»£ç ä¸åŸ C ä»£ç çš„åŠŸèƒ½å¯¹é½æ€§
- æ”¯æŒè¿­ä»£ä¼˜åŒ–ï¼Œç›´åˆ° Agent è®¤ä¸ºæ²¡æœ‰é—®é¢˜

ä½¿ç”¨æ–¹å¼ï¼š
- ä» CLI è°ƒç”¨ verify å­å‘½ä»¤
- è‡ªåŠ¨åˆ‡æ¢åˆ°ç›®æ ‡ crate ç›®å½•
- ä½¿ç”¨ task_list_manager æ‹†åˆ†å­ä»»åŠ¡è¿›è¡Œåˆ†æ
- ç”Ÿæˆç»“æ„åŒ–çš„å¯¹é½æŠ¥å‘Š
"""

from __future__ import annotations

import json
from pathlib import Path
from typing import Any
from typing import Dict

from jarvis.jarvis_c2rust.constants import CONFIG_JSON
from jarvis.jarvis_c2rust.constants import C2RUST_DIRNAME
from jarvis.jarvis_c2rust.constants import RUN_STATE_JSON
from jarvis.jarvis_utils.output import PrettyOutput


def check_transpile_completed(project_root: Path) -> bool:
    """
    æ£€æŸ¥è½¬è¯‘æ˜¯å¦å®Œæˆã€‚

    è¯»å– run_state.jsonï¼Œæ£€æŸ¥ transpile å’Œ optimize é˜¶æ®µæ˜¯å¦éƒ½å·²å®Œæˆã€‚
    """
    state_path = project_root / C2RUST_DIRNAME / RUN_STATE_JSON
    if not state_path.exists():
        return False

    try:
        with state_path.open("r", encoding="utf-8") as f:
            state = json.load(f)

        transpile_completed: bool = state.get("transpile", {}).get("completed", False)
        optimize_completed: bool = state.get("optimize", {}).get("completed", False)

        return transpile_completed and optimize_completed
    except Exception as e:
        PrettyOutput.auto_print(f"âš ï¸  [verify] è¯»å–çŠ¶æ€æ–‡ä»¶å¤±è´¥: {e}")
        return False


def load_config(project_root: Path) -> Dict[str, Any]:
    """
    åŠ è½½ c2rust é…ç½®ã€‚

    è¿”å›åŒ…å« root_symbolsã€disabled_libraries å’Œ additional_notes çš„å­—å…¸ã€‚
    """
    config_path = project_root / C2RUST_DIRNAME / CONFIG_JSON
    default_config = {
        "root_symbols": [],
        "disabled_libraries": [],
        "additional_notes": "",
    }

    if not config_path.exists():
        return default_config

    try:
        with config_path.open("r", encoding="utf-8") as f:
            config = json.load(f)
            if not isinstance(config, dict):
                return default_config
            return {
                "root_symbols": config.get("root_symbols", []),
                "disabled_libraries": config.get("disabled_libraries", []),
                "additional_notes": config.get("additional_notes", ""),
            }
    except Exception as e:
        PrettyOutput.auto_print(f"âš ï¸  [verify] è¯»å–é…ç½®æ–‡ä»¶å¤±è´¥: {e}")
        return default_config


def run_verify(
    project_root: Path,
    max_iterations: int = 10,
    non_interactive: bool = True,
) -> None:
    """
    æ‰§è¡ŒåŠŸèƒ½å¯¹é½éªŒè¯ã€‚

    å‚æ•°:
        project_root: é¡¹ç›®æ ¹ç›®å½•
        max_iterations: æœ€å¤§è¿­ä»£æ¬¡æ•°
        non_interactive: æ˜¯å¦éäº¤äº’æ¨¡å¼
    """
    from jarvis.jarvis_c2rust.utils import default_crate_dir

    # Step 1: æ£€æŸ¥è½¬è¯‘æ˜¯å¦å®Œæˆ
    PrettyOutput.auto_print("ğŸ” [verify] æ£€æŸ¥è½¬è¯‘çŠ¶æ€...")
    if not check_transpile_completed(project_root):
        PrettyOutput.auto_print(
            "âŒ [verify] è½¬è¯‘æœªå®Œæˆï¼Œè¯·å…ˆæ‰§è¡Œ 'jarvis-c2rust run' å®Œæˆè½¬è¯‘æµç¨‹"
        )
        return
    PrettyOutput.auto_print("âœ… [verify] è½¬è¯‘å·²å®Œæˆ")

    # ç¡®å®š crate ç›®å½•
    crate_dir = default_crate_dir(project_root)
    PrettyOutput.auto_print(f"ğŸ“ [verify] ç›®æ ‡ crate ç›®å½•: {crate_dir}")

    if not crate_dir.exists():
        PrettyOutput.auto_print(f"âŒ [verify] crate ç›®å½•ä¸å­˜åœ¨: {crate_dir}")
        return

    # åŠ è½½é…ç½®
    config = load_config(project_root)
    PrettyOutput.auto_print(
        f"ğŸ“‹ [verify] æ ¹ç¬¦å·æ•°: {len(config.get('root_symbols', []))}, "
        f"ç¦ç”¨åº“æ•°: {len(config.get('disabled_libraries', []))}"
    )

    # Step 2: åˆ‡æ¢åˆ° crate ç›®å½•å¹¶å¼€å§‹éªŒè¯
    PrettyOutput.auto_print("ğŸš€ [verify] å¼€å§‹åŠŸèƒ½å¯¹é½éªŒè¯...")

    import os

    original_cwd = os.getcwd()
    try:
        os.chdir(str(crate_dir))

        # ä½¿ç”¨ task_list_manager åˆ›å»ºå­ä»»åŠ¡è¿›è¡Œåˆ†æ
        PrettyOutput.auto_print(
            "ğŸ“‹ [verify] åˆ›å»ºåˆ†æä»»åŠ¡åˆ—è¡¨ï¼ˆæ‹†åˆ†å­ä»»åŠ¡è¿›è¡Œè¯¦ç»†åˆ†æï¼‰..."
        )

        # æ‰§è¡ŒåŠŸèƒ½å¯¹é½åˆ†æ
        alignment_result = _run_alignment_analysis(
            crate_dir=crate_dir,
            project_root=project_root,
            config=config,
            non_interactive=non_interactive,
        )

        # Step 3: æ£€æŸ¥æ˜¯å¦éœ€è¦è¿­ä»£ä¼˜åŒ–
        iteration = 0
        while iteration < max_iterations:
            is_aligned = alignment_result.get("is_aligned", False)

            if is_aligned:
                PrettyOutput.auto_print("âœ… [verify] åŠŸèƒ½å¯¹é½éªŒè¯é€šè¿‡ï¼")
                PrettyOutput.auto_print(
                    f"ğŸ“Š [verify] éªŒè¯ç»“æœ: {alignment_result.get('summary', 'OK')}"
                )
                break

            iteration += 1
            if iteration >= max_iterations:
                PrettyOutput.auto_print(
                    f"âš ï¸  [verify] è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•° ({max_iterations})ï¼Œåœæ­¢ä¼˜åŒ–"
                )
                PrettyOutput.auto_print(
                    f"ğŸ“Š [verify] æœ€ç»ˆéªŒè¯ç»“æœ: {alignment_result.get('summary', 'NOT OK')}"
                )
                break

            PrettyOutput.auto_print(f"ğŸ”„ [verify] ç¬¬ {iteration} æ¬¡è¿­ä»£ä¼˜åŒ–...")

            # æ‰§è¡Œä¼˜åŒ–
            _run_optimization(
                crate_dir=crate_dir,
                project_root=project_root,
                report=alignment_result.get("report", ""),
                config=config,
                non_interactive=non_interactive,
            )

            # é‡æ–°éªŒè¯
            PrettyOutput.auto_print("ğŸ” [verify] é‡æ–°éªŒè¯åŠŸèƒ½å¯¹é½...")
            alignment_result = _run_alignment_analysis(
                crate_dir=crate_dir,
                project_root=project_root,
                config=config,
                non_interactive=non_interactive,
            )
    finally:
        os.chdir(original_cwd)


def _run_alignment_analysis(
    crate_dir: Path,
    project_root: Path,
    config: Dict[str, Any],
    non_interactive: bool,
) -> Dict[str, Any]:
    """
    è¿è¡ŒåŠŸèƒ½å¯¹é½åˆ†æã€‚

    ä½¿ç”¨ task_list_manager æ‹†åˆ†å­ä»»åŠ¡è¿›è¡Œåˆ†æã€‚
    å­ä»»åŠ¡å°†ä¸ä¸€è‡´çš„åœ°æ–¹è®°å½•åˆ°æ–‡ä»¶ä¸­ï¼Œæœ€ç»ˆæ€»ç»“åŸºäºè¿™äº›æ–‡ä»¶ç”Ÿæˆã€‚
    è¿”å›åŒ…å« is_aligned å’Œ summary çš„å­—å…¸ã€‚
    """
    from jarvis.jarvis_agent import Agent

    # å®šä¹‰æŠ¥å‘Šæ–‡ä»¶è·¯å¾„ï¼ˆä¿å­˜åˆ° crate æ ¹ç›®å½•ï¼‰
    report_file = crate_dir / "alignment_report.md"

    # åˆ›å»ºåˆ†æ Agent
    # ç³»ç»Ÿæç¤ºè¯ï¼šä»‹ç»æ˜ç¡®çš„å·¥ä½œæµç¨‹ï¼ˆæ”¯æŒå¤§è§„æ¨¡ä»£ç ï¼‰
    system_prompt = f"""
ä½ æ˜¯ä¸€ä¸ª C åˆ° Rust ä»£ç è½¬è¯‘çš„åŠŸèƒ½å¯¹é½éªŒè¯ä¸“å®¶ã€‚

## æ ¸å¿ƒèŒè´£
åˆ†æè½¬è¯‘åçš„ Rust ä»£ç ä¸åŸ C ä»£ç çš„åŠŸèƒ½å¯¹é½æ€§ï¼Œè¯†åˆ«ä¸ä¸€è‡´é—®é¢˜å¹¶ç”Ÿæˆè¯¦ç»†æŠ¥å‘Šã€‚

## æ˜ç¡®çš„å·¥ä½œæµç¨‹ï¼ˆå¿…é¡»ä¸¥æ ¼æŒ‰é¡ºåºæ‰§è¡Œï¼Œæ”¯æŒå¤§è§„æ¨¡ä»£ç åˆ†æï¼‰

### é˜¶æ®µ1ï¼šå‡†å¤‡å·¥ä½œï¼ˆå¿…é¡»é¦–å…ˆå®Œæˆï¼‰
1. **è¯»å–é¡¹ç›®é…ç½®**
   - è¯»å–é¡¹ç›®æ ¹ç›®å½•å’Œ crate ç›®å½•ä¿¡æ¯
   - ç†è§£æ ¹ç¬¦å·åˆ—è¡¨ï¼ˆroot_symbolsï¼‰å’Œç¦ç”¨åº“åˆ—è¡¨ï¼ˆdisabled_librariesï¼‰
   - æŸ¥çœ‹é™„åŠ è¯´æ˜ï¼ˆadditional_notesï¼‰

2. **æ¢ç´¢ä»£ç ç»“æ„å¹¶è¯†åˆ«æ–‡ä»¶æ˜ å°„**
   - åˆ—å‡ºæ‰€æœ‰ C æºä»£ç æ–‡ä»¶ä½ç½®ï¼ˆä½¿ç”¨ glob æˆ– list_dir å·¥å…·ï¼‰
   - åˆ—å‡ºæ‰€æœ‰è½¬è¯‘åçš„ Rust ä»£ç æ–‡ä»¶ä½ç½®
   - **å»ºç«‹ C æ–‡ä»¶ä¸ Rust æ–‡ä»¶çš„å¯¹åº”å…³ç³»**ï¼ˆè¿™æ˜¯å…³é”®æ­¥éª¤ï¼‰
   - ä¼°ç®—æ¯ä¸ªæ–‡ä»¶çš„å¤§å°ï¼ˆè¡Œæ•°ï¼‰ï¼Œå¦‚æœå•ä¸ªæ–‡ä»¶è¶…è¿‡ 2000 è¡Œï¼Œè€ƒè™‘è¿›ä¸€æ­¥æ‹†åˆ†

### é˜¶æ®µ2ï¼šæŒ‰æ–‡ä»¶åˆ›å»ºä»»åŠ¡åˆ—è¡¨ï¼ˆå¿…é¡»ä½¿ç”¨ task_list_managerï¼‰
3. **ä½¿ç”¨ task_list_manager.add_tasks åˆ›å»ºä»»åŠ¡åˆ—è¡¨**
   - main_goal: "C2Rust åŠŸèƒ½å¯¹é½éªŒè¯ï¼šæŒ‰æ–‡ä»¶åˆ†æè½¬è¯‘åçš„ Rust ä»£ç ä¸åŸ C ä»£ç çš„åŠŸèƒ½å¯¹é½æ€§"
   - tasks_info: **æŒ‰æ–‡ä»¶æ‹†åˆ†ä»»åŠ¡**ï¼Œæ¯ä¸ªæ–‡ä»¶ä¸€ä¸ªå­ä»»åŠ¡ï¼š
     * ä¸ºæ¯ä¸ª C-Rust æ–‡ä»¶å¯¹åˆ›å»ºä¸€ä¸ªä»»åŠ¡ï¼Œä»»åŠ¡åæ ¼å¼ï¼š"éªŒè¯æ–‡ä»¶: <æ–‡ä»¶å>"
     * æ¯ä¸ªæ–‡ä»¶ä»»åŠ¡éœ€è¦å®Œæˆä»¥ä¸‹æ‰€æœ‰åˆ†æç»´åº¦ï¼š
       - å‡½æ•°ç­¾åå’Œç±»å‹å®šä¹‰å¯¹æ¯”
       - å‡½æ•°é€»è¾‘å’Œç®—æ³•å®ç°å¯¹æ¯”
       - é”™è¯¯å¤„ç†æœºåˆ¶éªŒè¯
       - å†…å­˜å®‰å…¨æ€§éªŒè¯
       - æ•°æ®ç»“æ„å’Œå¸ƒå±€å¯¹é½éªŒè¯
     * æœ€åä¸€ä¸ªæ±‡æ€»ä»»åŠ¡ï¼š"æ±‡æ€»æ‰€æœ‰æ–‡ä»¶æŠ¥å‘Šå¹¶ç”Ÿæˆæœ€ç»ˆå¯¹é½æŠ¥å‘Š"
   - **é‡è¦**ï¼šæ–‡ä»¶ä»»åŠ¡ä¹‹é—´å¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼ˆæ— ä¾èµ–å…³ç³»ï¼‰ï¼Œåªæœ‰æ±‡æ€»ä»»åŠ¡ä¾èµ–æ‰€æœ‰æ–‡ä»¶ä»»åŠ¡

### é˜¶æ®µ3ï¼šæ‰§è¡Œæ–‡ä»¶çº§ä»»åŠ¡ï¼ˆé€ä¸ªæˆ–å¹¶è¡Œæ‰§è¡Œï¼‰
4. **ä½¿ç”¨ task_list_manager.execute_task æ‰§è¡Œæ¯ä¸ªæ–‡ä»¶ä»»åŠ¡**
   - å¯¹äºæ¯ä¸ªæ–‡ä»¶ä»»åŠ¡ï¼Œæä¾›è¯¦ç»†çš„ additional_infoï¼š
     * c_file_path: C æºä»£ç æ–‡ä»¶è·¯å¾„
     * rust_file_path: å¯¹åº”çš„ Rust ä»£ç æ–‡ä»¶è·¯å¾„
     * root_symbols_in_file: è¯¥æ–‡ä»¶ä¸­éœ€è¦éªŒè¯çš„æ ¹ç¬¦å·åˆ—è¡¨
     * analysis_dimensions: éœ€è¦åˆ†æçš„ç»´åº¦åˆ—è¡¨ï¼ˆå‡½æ•°ç­¾åã€é€»è¾‘ã€é”™è¯¯å¤„ç†ã€å†…å­˜å®‰å…¨ã€å¸ƒå±€å¯¹é½ï¼‰
   
   - æ¯ä¸ªæ–‡ä»¶ä»»åŠ¡æ‰§è¡Œæ—¶ï¼š
     * è¯»å–å¹¶åˆ†æ C ä»£ç æ–‡ä»¶ï¼ˆå¦‚æœæ–‡ä»¶å¾ˆå¤§ï¼Œå¯ä»¥åˆ†å—è¯»å–å…³é”®éƒ¨åˆ†ï¼‰
     * è¯»å–å¹¶åˆ†æå¯¹åº”çš„ Rust ä»£ç æ–‡ä»¶
     * **å¯¹æ¯ä¸ªåˆ†æç»´åº¦è¿›è¡Œè¯¦ç»†å¯¹æ¯”**ï¼š
       - å‡½æ•°ç­¾åå’Œç±»å‹å®šä¹‰å¯¹æ¯”
       - å‡½æ•°é€»è¾‘å’Œç®—æ³•å®ç°å¯¹æ¯”
       - é”™è¯¯å¤„ç†æœºåˆ¶éªŒè¯
       - å†…å­˜å®‰å…¨æ€§éªŒè¯
       - æ•°æ®ç»“æ„å’Œå¸ƒå±€å¯¹é½éªŒè¯
     * è®°å½•å‘ç°çš„é—®é¢˜ï¼ˆæ ¼å¼ï¼šå‡½æ•°åã€é—®é¢˜æè¿°ã€ä¸¥é‡ç¨‹åº¦ã€ä»£ç å¯¹æ¯”ï¼‰
     * **ç«‹å³ç”Ÿæˆè¯¥æ–‡ä»¶çš„éƒ¨åˆ†æŠ¥å‘Š**ï¼Œä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶ï¼š`{{crate_dir}}/alignment_reports/{{filename}}_report.md`
     * å°†é—®é¢˜ç»Ÿè®¡ä¿¡æ¯ï¼ˆé—®é¢˜æ•°é‡ã€ä¸¥é‡ç¨‹åº¦åˆ†å¸ƒï¼‰è®°å½•åœ¨ä»»åŠ¡ç»“æœä¸­

### é˜¶æ®µ4ï¼šæ±‡æ€»å’ŒæŠ¥å‘Šç”Ÿæˆï¼ˆæœ€åä¸€ä¸ªä»»åŠ¡ï¼‰
5. **æ‰§è¡Œ"æ±‡æ€»æ‰€æœ‰æ–‡ä»¶æŠ¥å‘Šå¹¶ç”Ÿæˆæœ€ç»ˆå¯¹é½æŠ¥å‘Š"ä»»åŠ¡**
   - è¯»å–æ‰€æœ‰å·²å®Œæˆæ–‡ä»¶ä»»åŠ¡çš„ç»“æœå’Œéƒ¨åˆ†æŠ¥å‘Šæ–‡ä»¶
   - æ±‡æ€»æ‰€æœ‰æ–‡ä»¶çš„é—®é¢˜ç»Ÿè®¡
   - æŒ‰ä¸¥é‡ç¨‹åº¦åˆ†ç±»ï¼ˆHigh/Medium/Lowï¼‰
   - ç”Ÿæˆå®Œæ•´çš„ Markdown æŠ¥å‘Šï¼ŒåŒ…å«ï¼š
     * **æ€»ä½“ç»“è®º**ï¼ˆä¸€è‡´/ä¸ä¸€è‡´/éƒ¨åˆ†ä¸€è‡´ï¼‰
     * **ç»Ÿè®¡ä¿¡æ¯**ï¼šæ€»æ–‡ä»¶æ•°ã€å·²åˆ†ææ–‡ä»¶æ•°ã€æ€»é—®é¢˜æ•°ã€High/Medium/Low æ•°é‡
     * **æŒ‰æ–‡ä»¶åˆ†ç»„çš„é—®é¢˜åˆ—è¡¨**ï¼šæ¯ä¸ªæ–‡ä»¶çš„é—®é¢˜æ‘˜è¦ï¼ˆé—®é¢˜æ•°é‡ã€ä¸¥é‡ç¨‹åº¦åˆ†å¸ƒï¼‰
     * **å…³é”®é—®é¢˜è¯¦ç»†åˆ—è¡¨**ï¼šæ±‡æ€»æ‰€æœ‰ High å’Œ Medium çº§åˆ«é—®é¢˜ï¼ˆæ¯ä¸ªé—®é¢˜åŒ…å«ï¼šæ–‡ä»¶åã€å‡½æ•°åã€é—®é¢˜æè¿°ã€ä¸¥é‡ç¨‹åº¦ã€ä»£ç å¯¹æ¯”ï¼‰
     * **æ”¹è¿›å»ºè®®**ï¼šé’ˆå¯¹å‘ç°çš„é—®é¢˜æå‡ºå…·ä½“çš„ä¿®å¤å»ºè®®
   - å°†æŠ¥å‘Šå†™å…¥æŒ‡å®šæ–‡ä»¶ï¼š{report_file}

### é˜¶æ®µ5ï¼šè¾“å‡ºéªŒè¯ç»“æœï¼ˆæœ€ç»ˆæ­¥éª¤ï¼‰
6. **è¾“å‡ºéªŒè¯ç»“æœ**
   - è¯»å–ç”Ÿæˆçš„æŠ¥å‘Šæ–‡ä»¶ï¼š{report_file}
   - æ ¹æ®æŠ¥å‘Šå†…å®¹åˆ¤æ–­éªŒè¯ç»“æœï¼š
     * å¦‚æœæ‰€æœ‰é—®é¢˜éƒ½æ˜¯ Low çº§åˆ«æˆ–æ²¡æœ‰é—®é¢˜ â†’ is_aligned: true
     * å¦‚æœå­˜åœ¨ High æˆ– Medium çº§åˆ«é—®é¢˜ â†’ is_aligned: false
   - ç”Ÿæˆç®€æ´çš„ summary æè¿°ï¼ˆä¾‹å¦‚ï¼š"å®Œå…¨ä¸€è‡´"ã€"å­˜åœ¨ High çº§åˆ«é—®é¢˜"ã€"éƒ¨åˆ†ä¸€è‡´ï¼Œä¸»è¦æ˜¯ Low çº§åˆ«é—®é¢˜"ï¼‰
   - **æœ€ç»ˆè¾“å‡ºè¦æ±‚**ï¼šä»»åŠ¡å®Œæˆåï¼Œç³»ç»Ÿä¼šè¦æ±‚ä½ ç”Ÿæˆæœ€ç»ˆæ€»ç»“ã€‚åœ¨æœ€ç»ˆæ€»ç»“ä¸­ï¼Œå¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼è¾“å‡ºéªŒè¯ç»“æœï¼š
```json
{{
  "is_aligned": true/false,
  "summary": "æ€»ä½“ç»“è®ºï¼ˆä¸€è‡´/ä¸ä¸€è‡´/éƒ¨åˆ†ä¸€è‡´ï¼‰",
  "report_path": "{report_file}"
}}
```

## é‡è¦çº¦æŸ
- **å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°5ä¸ªé˜¶æ®µçš„é¡ºåºæ‰§è¡Œï¼Œä¸èƒ½è·³è¿‡ä»»ä½•é˜¶æ®µ**
- **å¿…é¡»ä½¿ç”¨ task_list_manager å·¥å…·ï¼Œä¸èƒ½ç›´æ¥æ‰§è¡Œåˆ†æ**
- **å¿…é¡»æŒ‰æ–‡ä»¶æ‹†åˆ†ä»»åŠ¡ï¼Œè€Œä¸æ˜¯æŒ‰åˆ†æç»´åº¦æ‹†åˆ†**ï¼ˆè¿™æ ·æ‰èƒ½æ”¯æŒå¤§è§„æ¨¡ä»£ç ï¼‰
- **æ¯ä¸ªæ–‡ä»¶ä»»åŠ¡å®Œæˆåç«‹å³ç”Ÿæˆè¯¥æ–‡ä»¶çš„éƒ¨åˆ†æŠ¥å‘Š**ï¼ˆæ”¯æŒå¢é‡æŸ¥çœ‹è¿›åº¦ï¼‰
- **æ¯ä¸ªå­ä»»åŠ¡å¿…é¡»æä¾›è¯¦ç»†çš„ additional_info**
- **é—®é¢˜è®°å½•æ ¼å¼å¿…é¡»ç»Ÿä¸€ï¼ŒåŒ…å«ï¼šæ–‡ä»¶åã€å‡½æ•°åã€é—®é¢˜æè¿°ã€ä¸¥é‡ç¨‹åº¦ã€ä»£ç å¯¹æ¯”**
- **æœ€ç»ˆå¿…é¡»è¾“å‡ºæœ‰æ•ˆçš„ JSON æ ¼å¼ç»“æœ**

## å¤§è§„æ¨¡ä»£ç å¤„ç†ç­–ç•¥
- **æ–‡ä»¶æ‹†åˆ†åŸåˆ™**ï¼šå¦‚æœå•ä¸ªæ–‡ä»¶è¶…è¿‡ 2000 è¡Œï¼Œè€ƒè™‘æŒ‰å‡½æ•°ç»„æˆ–æ¨¡å—è¿›ä¸€æ­¥æ‹†åˆ†
- **å¢é‡æŠ¥å‘Š**ï¼šæ¯ä¸ªæ–‡ä»¶åˆ†æå®Œæˆåç«‹å³ç”Ÿæˆéƒ¨åˆ†æŠ¥å‘Šï¼Œä¾¿äºè·Ÿè¸ªè¿›åº¦
- **å¹¶è¡Œæ‰§è¡Œ**ï¼šæ–‡ä»¶ä»»åŠ¡ä¹‹é—´æ— ä¾èµ–ï¼Œå¯ä»¥å¹¶è¡Œæ‰§è¡Œä»¥æé«˜æ•ˆç‡
- **å†…å­˜ä¼˜åŒ–**ï¼šå¯¹äºå¤§æ–‡ä»¶ï¼Œåªè¯»å–éœ€è¦åˆ†æçš„å…³é”®éƒ¨åˆ†ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½å…¨éƒ¨å†…å®¹
"""

    # æ€»ç»“æç¤ºè¯ï¼šçº¦æŸç»“è®ºç»“æœï¼ˆAgent å®Œæˆæ‰€æœ‰ä»»åŠ¡åä¼šè‡ªåŠ¨è°ƒç”¨æ­¤æç¤ºè¯ï¼‰
    summary_prompt = f"""
è¯·åŸºäºåŠŸèƒ½å¯¹é½éªŒè¯çš„åˆ†æç»“æœï¼Œä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼è¾“å‡ºæœ€ç»ˆç»“è®ºï¼š

```json
{{
  "is_aligned": true/false,
  "summary": "æ€»ä½“ç»“è®ºï¼ˆä¸€è‡´/ä¸ä¸€è‡´/éƒ¨åˆ†ä¸€è‡´ï¼‰",
  "report_path": "{report_file}"
}}
```

è¦æ±‚ï¼š
- å¿…é¡»è¾“å‡ºå®Œæ•´çš„ JSON æ ¼å¼ï¼Œä¸è¦åŒ…å«å…¶ä»–æ–‡æœ¬
- is_aligned: true è¡¨ç¤ºå®Œå…¨å¯¹é½ï¼ˆæ‰€æœ‰é—®é¢˜éƒ½æ˜¯ Low çº§åˆ«æˆ–æ²¡æœ‰é—®é¢˜ï¼‰ï¼Œfalse è¡¨ç¤ºå­˜åœ¨ High æˆ– Medium çº§åˆ«çš„ä¸ä¸€è‡´é—®é¢˜
- summary: ç®€æ´æè¿°æ€»ä½“ç»“è®ºï¼Œä¾‹å¦‚ï¼š"å®Œå…¨ä¸€è‡´"ã€"å­˜åœ¨ High çº§åˆ«é—®é¢˜"ã€"éƒ¨åˆ†ä¸€è‡´ï¼Œä¸»è¦æ˜¯ Low çº§åˆ«é—®é¢˜"
- report_path: ç”Ÿæˆçš„æŠ¥å‘Šæ–‡ä»¶è·¯å¾„ï¼ˆå¿…é¡»æ˜¯ï¼š{report_file}ï¼‰

è¯·å…ˆè¯»å–æŠ¥å‘Šæ–‡ä»¶ {report_file}ï¼Œæ ¹æ®æŠ¥å‘Šå†…å®¹åˆ¤æ–­ is_aligned çš„å€¼ï¼Œç„¶åè¾“å‡º JSONã€‚
"""

    agent = Agent(
        name="C2Rust-VerificationAgent",
        non_interactive=non_interactive,
        system_prompt=system_prompt,
        summary_prompt=summary_prompt,
    )

    # æ„å»ºåˆ†æä»»åŠ¡
    analysis_task = f"""
ä½ æ˜¯ä¸€ä¸ª C åˆ° Rust ä»£ç è½¬è¯‘çš„åŠŸèƒ½å¯¹é½éªŒè¯ä¸“å®¶ã€‚

## ä»»åŠ¡ç›®æ ‡
åˆ†æè½¬è¯‘åçš„ Rust ä»£ç ä¸åŸ C ä»£ç çš„åŠŸèƒ½å¯¹é½æ€§ï¼Œè¯†åˆ«ä¸ä¸€è‡´é—®é¢˜å¹¶ç”Ÿæˆè¯¦ç»†çš„å¯¹é½æŠ¥å‘Šã€‚

## é¡¹ç›®ä¿¡æ¯
- é¡¹ç›®æ ¹ç›®å½•: {project_root}
- Rust crate ç›®å½•: {crate_dir}
- æ ¹ç¬¦å·åˆ—è¡¨: {config.get("root_symbols", [])}
- ç¦ç”¨åº“åˆ—è¡¨: {config.get("disabled_libraries", [])}
- é™„åŠ è¯´æ˜: {config.get("additional_notes", "")}

## è¾“å‡ºæ–‡ä»¶
- å¯¹é½æ€»ç»“æŠ¥å‘Š: {report_file}
- éƒ¨åˆ†æŠ¥å‘Šç›®å½•: {crate_dir}/alignment_reports/ï¼ˆæ¯ä¸ªæ–‡ä»¶çš„åˆ†ææŠ¥å‘Šï¼‰

## æ‰§è¡Œæ­¥éª¤ï¼ˆä¸¥æ ¼æŒ‰ç…§ç³»ç»Ÿæç¤ºè¯ä¸­çš„å·¥ä½œæµç¨‹ï¼Œæ”¯æŒå¤§è§„æ¨¡ä»£ç ï¼‰

### ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡å·¥ä½œï¼ˆæ¢ç´¢ä»£ç ç»“æ„ï¼‰
1. **æ¢ç´¢ C æºä»£ç ä½ç½®**
   - ä½¿ç”¨ list_dir æˆ– glob å·¥å…·æ‰¾åˆ°æ‰€æœ‰ C æºä»£ç æ–‡ä»¶ï¼ˆé€šå¸¸åœ¨é¡¹ç›®æ ¹ç›®å½•çš„æŸä¸ªå­ç›®å½•ï¼‰
   - è®°å½•æ‰€æœ‰ C æ–‡ä»¶çš„å®Œæ•´è·¯å¾„

2. **æ¢ç´¢ Rust ä»£ç ç»“æ„**
   - ç¡®è®¤ Rust crate ç›®å½•ç»“æ„ï¼ˆå½“å‰ç›®å½•ï¼š{crate_dir}ï¼‰
   - ä½¿ç”¨ list_dir æˆ– glob å·¥å…·æ‰¾åˆ°æ‰€æœ‰ Rust æºä»£ç æ–‡ä»¶
   - è®°å½•æ‰€æœ‰ Rust æ–‡ä»¶çš„å®Œæ•´è·¯å¾„

3. **å»ºç«‹æ–‡ä»¶æ˜ å°„å…³ç³»**
   - å»ºç«‹ C æ–‡ä»¶ä¸ Rust æ–‡ä»¶çš„å¯¹åº”å…³ç³»ï¼ˆé€šå¸¸æ–‡ä»¶åç›¸ä¼¼æˆ–è·¯å¾„ç»“æ„ç›¸ä¼¼ï¼‰
   - å¯¹äºæ¯ä¸ªæ–‡ä»¶å¯¹ï¼Œè¯†åˆ«å…¶ä¸­åŒ…å«çš„æ ¹ç¬¦å·
   - ä¼°ç®—æ¯ä¸ªæ–‡ä»¶çš„å¤§å°ï¼ˆè¡Œæ•°ï¼‰ï¼Œå¦‚æœè¶…è¿‡ 2000 è¡Œï¼Œè€ƒè™‘è¿›ä¸€æ­¥æ‹†åˆ†

4. **åˆ›å»ºéƒ¨åˆ†æŠ¥å‘Šç›®å½•**
   - åˆ›å»ºç›®å½•ï¼š{crate_dir}/alignment_reports/ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰

### ç¬¬äºŒæ­¥ï¼šæŒ‰æ–‡ä»¶åˆ›å»ºä»»åŠ¡åˆ—è¡¨
**å¿…é¡»ç«‹å³ä½¿ç”¨ task_list_manager.add_tasks åˆ›å»ºä»»åŠ¡åˆ—è¡¨**

**é‡è¦ï¼šå¿…é¡»æŒ‰æ–‡ä»¶æ‹†åˆ†ï¼Œè€Œä¸æ˜¯æŒ‰åˆ†æç»´åº¦æ‹†åˆ†ï¼**

è°ƒç”¨ç¤ºä¾‹ï¼ˆå‡è®¾æœ‰ file1.c/file1.rs, file2.c/file2.rs ä¸¤ä¸ªæ–‡ä»¶å¯¹ï¼‰ï¼š
```python
task_list_manager(
    action="add_tasks",
    main_goal="C2Rust åŠŸèƒ½å¯¹é½éªŒè¯ï¼šæŒ‰æ–‡ä»¶åˆ†æè½¬è¯‘åçš„ Rust ä»£ç ä¸åŸ C ä»£ç çš„åŠŸèƒ½å¯¹é½æ€§",
    tasks_info=[
        {{
            "name": "éªŒè¯æ–‡ä»¶: file1.c",
            "description": "åˆ†æ file1.c ä¸ file1.rs çš„åŠŸèƒ½å¯¹é½æ€§ï¼ŒåŒ…æ‹¬å‡½æ•°ç­¾åã€é€»è¾‘ã€é”™è¯¯å¤„ç†ã€å†…å­˜å®‰å…¨ã€å¸ƒå±€å¯¹é½ç­‰æ‰€æœ‰ç»´åº¦",
            "dependencies": []
        }},
        {{
            "name": "éªŒè¯æ–‡ä»¶: file2.c",
            "description": "åˆ†æ file2.c ä¸ file2.rs çš„åŠŸèƒ½å¯¹é½æ€§ï¼ŒåŒ…æ‹¬å‡½æ•°ç­¾åã€é€»è¾‘ã€é”™è¯¯å¤„ç†ã€å†…å­˜å®‰å…¨ã€å¸ƒå±€å¯¹é½ç­‰æ‰€æœ‰ç»´åº¦",
            "dependencies": []
        }},
        # ... ä¸ºæ¯ä¸ªæ–‡ä»¶å¯¹åˆ›å»ºä¸€ä¸ªä»»åŠ¡
        {{
            "name": "æ±‡æ€»æ‰€æœ‰æ–‡ä»¶æŠ¥å‘Šå¹¶ç”Ÿæˆæœ€ç»ˆå¯¹é½æŠ¥å‘Š",
            "description": "æ±‡æ€»æ‰€æœ‰æ–‡ä»¶ä»»åŠ¡çš„åˆ†æç»“æœï¼Œç”Ÿæˆå®Œæ•´çš„å¯¹é½æŠ¥å‘Š",
            "dependencies": ["éªŒè¯æ–‡ä»¶: file1.c", "éªŒè¯æ–‡ä»¶: file2.c", ...]  # ä¾èµ–æ‰€æœ‰æ–‡ä»¶ä»»åŠ¡
        }}
    ]
)
```

**å…³é”®ç‚¹ï¼š**
- æ¯ä¸ªæ–‡ä»¶ä¸€ä¸ªç‹¬ç«‹ä»»åŠ¡ï¼Œæ–‡ä»¶ä»»åŠ¡ä¹‹é—´æ— ä¾èµ–ï¼ˆå¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼‰
- æ¯ä¸ªæ–‡ä»¶ä»»åŠ¡éœ€è¦å®Œæˆæ‰€æœ‰åˆ†æç»´åº¦ï¼ˆå‡½æ•°ç­¾åã€é€»è¾‘ã€é”™è¯¯å¤„ç†ã€å†…å­˜å®‰å…¨ã€å¸ƒå±€å¯¹é½ï¼‰
- æœ€åä¸€ä¸ªæ±‡æ€»ä»»åŠ¡ä¾èµ–æ‰€æœ‰æ–‡ä»¶ä»»åŠ¡

### ç¬¬ä¸‰æ­¥ï¼šæ‰§è¡Œæ–‡ä»¶çº§ä»»åŠ¡
**å¯¹æ¯ä¸ªæ–‡ä»¶ä»»åŠ¡ï¼Œä½¿ç”¨ task_list_manager.execute_task æ‰§è¡Œ**

æ¯ä¸ªæ–‡ä»¶ä»»åŠ¡æ‰§è¡Œæ—¶ï¼Œå¿…é¡»æä¾›è¯¦ç»†çš„ additional_infoï¼š

**ç¤ºä¾‹ï¼šéªŒè¯æ–‡ä»¶ file1.c ä»»åŠ¡çš„ additional_info**
```json
{{
    "c_file_path": "/path/to/file1.c",
    "rust_file_path": "/path/to/file1.rs",
    "root_symbols_in_file": ["function1", "function2", "Struct1"],
    "analysis_dimensions": [
        "å‡½æ•°ç­¾åå’Œç±»å‹å®šä¹‰å¯¹æ¯”",
        "å‡½æ•°é€»è¾‘å’Œç®—æ³•å®ç°å¯¹æ¯”",
        "é”™è¯¯å¤„ç†æœºåˆ¶éªŒè¯",
        "å†…å­˜å®‰å…¨æ€§éªŒè¯",
        "æ•°æ®ç»“æ„å’Œå¸ƒå±€å¯¹é½éªŒè¯"
    ],
    "output_file": "{crate_dir}/alignment_reports/file1_report.md"
}}
```

**æ¯ä¸ªæ–‡ä»¶ä»»åŠ¡æ‰§è¡Œæ­¥éª¤ï¼š**
1. è¯»å– C ä»£ç æ–‡ä»¶ï¼ˆå¦‚æœæ–‡ä»¶å¾ˆå¤§ï¼Œå¯ä»¥åˆ†å—è¯»å–å…³é”®éƒ¨åˆ†ï¼‰
2. è¯»å–å¯¹åº”çš„ Rust ä»£ç æ–‡ä»¶
3. **å¯¹æ¯ä¸ªåˆ†æç»´åº¦è¿›è¡Œè¯¦ç»†å¯¹æ¯”**ï¼š
   - **å‡½æ•°ç­¾åå’Œç±»å‹å®šä¹‰å¯¹æ¯”**ï¼šå¯¹æ¯”å‡½æ•°ç­¾åã€å‚æ•°ç±»å‹ã€è¿”å›å€¼ç±»å‹ã€ç±»å‹å®šä¹‰
   - **å‡½æ•°é€»è¾‘å’Œç®—æ³•å®ç°å¯¹æ¯”**ï¼šé€è¡Œå¯¹æ¯”å‡½æ•°å®ç°é€»è¾‘ã€ç®—æ³•ä¸€è‡´æ€§ã€è¾¹ç•Œæ¡ä»¶å¤„ç†
   - **é”™è¯¯å¤„ç†æœºåˆ¶éªŒè¯**ï¼šå¯¹æ¯” C çš„é”™è¯¯å¤„ç†ï¼ˆè¿”å›å€¼ã€errnoï¼‰ä¸ Rust çš„é”™è¯¯å¤„ç†ï¼ˆResultã€Optionï¼‰
   - **å†…å­˜å®‰å…¨æ€§éªŒè¯**ï¼šæ£€æŸ¥ unsafe ä»£ç å—ã€å†…å­˜ç®¡ç†ã€æŒ‡é’ˆæ“ä½œå®‰å…¨æ€§
   - **æ•°æ®ç»“æ„å’Œå¸ƒå±€å¯¹é½éªŒè¯**ï¼šéªŒè¯ç»“æ„ä½“å­—æ®µé¡ºåºã€å†…å­˜å¸ƒå±€å¯¹é½ã€å¤§å°ç«¯å¤„ç†
4. è®°å½•æ‰€æœ‰å‘ç°çš„é—®é¢˜ï¼ˆæ ¼å¼è§ä¸‹æ–¹ï¼‰
5. **ç«‹å³ç”Ÿæˆè¯¥æ–‡ä»¶çš„éƒ¨åˆ†æŠ¥å‘Š**ï¼Œä¿å­˜åˆ°ï¼š`{crate_dir}/alignment_reports/{{filename}}_report.md`
6. åœ¨ä»»åŠ¡ç»“æœä¸­è®°å½•é—®é¢˜ç»Ÿè®¡ï¼ˆé—®é¢˜æ•°é‡ã€ä¸¥é‡ç¨‹åº¦åˆ†å¸ƒï¼‰

**é—®é¢˜è®°å½•æ ¼å¼ï¼ˆæ¯ä¸ªæ–‡ä»¶ä»»åŠ¡å¿…é¡»éµå¾ªï¼‰ï¼š**
```
### [ä¸¥é‡ç¨‹åº¦] æ–‡ä»¶å: å‡½æ•°å/ç±»å‹å

**é—®é¢˜æè¿°**ï¼šè¯¦ç»†æè¿°é—®é¢˜

**C ä»£ç **ï¼š
```c
// C ä»£ç ç‰‡æ®µï¼ˆåŒ…å«æ–‡ä»¶è·¯å¾„å’Œè¡Œå·ï¼‰
```

**Rust ä»£ç **ï¼š
```rust
// Rust ä»£ç ç‰‡æ®µï¼ˆåŒ…å«æ–‡ä»¶è·¯å¾„å’Œè¡Œå·ï¼‰
```

**å½±å“åˆ†æ**ï¼šè¯´æ˜è¿™ä¸ªé—®é¢˜å¯èƒ½é€ æˆçš„å½±å“

**åˆ†æç»´åº¦**ï¼šå‡½æ•°ç­¾å/é€»è¾‘/é”™è¯¯å¤„ç†/å†…å­˜å®‰å…¨/å¸ƒå±€å¯¹é½
```

**éƒ¨åˆ†æŠ¥å‘Šæ ¼å¼ï¼ˆæ¯ä¸ªæ–‡ä»¶ä»»åŠ¡å®Œæˆåç«‹å³ç”Ÿæˆï¼‰ï¼š**
```markdown
# æ–‡ä»¶å¯¹é½æŠ¥å‘Š: file1.c / file1.rs

## æ–‡ä»¶ä¿¡æ¯
- C æ–‡ä»¶: /path/to/file1.c
- Rust æ–‡ä»¶: /path/to/file1.rs
- æ ¹ç¬¦å·æ•°: 3

## é—®é¢˜ç»Ÿè®¡
- æ€»é—®é¢˜æ•°: 5
- High: 1
- Medium: 2
- Low: 2

## é—®é¢˜åˆ—è¡¨
[æŒ‰ä¸Šè¿°æ ¼å¼åˆ—å‡ºæ‰€æœ‰é—®é¢˜]

## åˆ†æç»´åº¦æ€»ç»“
- å‡½æ•°ç­¾åå’Œç±»å‹å®šä¹‰: 1ä¸ªé—®é¢˜
- å‡½æ•°é€»è¾‘å’Œç®—æ³•å®ç°: 2ä¸ªé—®é¢˜
- é”™è¯¯å¤„ç†æœºåˆ¶: 1ä¸ªé—®é¢˜
- å†…å­˜å®‰å…¨æ€§: 1ä¸ªé—®é¢˜
- æ•°æ®ç»“æ„å’Œå¸ƒå±€å¯¹é½: 0ä¸ªé—®é¢˜
```

**ä¸¥é‡ç¨‹åº¦åˆ†ç±»ï¼š**
- **High**ï¼šä¸¥é‡å½±å“åŠŸèƒ½æˆ–å®‰å…¨æ€§çš„é—®é¢˜ï¼ˆå¦‚ï¼šé€»è¾‘é”™è¯¯ã€å†…å­˜å®‰å…¨é—®é¢˜ã€åŠŸèƒ½ç¼ºå¤±ï¼‰
- **Medium**ï¼šä¸­ç­‰å½±å“çš„é—®é¢˜ï¼ˆå¦‚ï¼šç±»å‹ä¸åŒ¹é…ä½†ä¸å½±å“åŠŸèƒ½ã€é”™è¯¯å¤„ç†æ–¹å¼ä¸åŒä½†ç»“æœä¸€è‡´ï¼‰
- **Low**ï¼šè½»å¾®æˆ–ä¸å½±å“åŠŸèƒ½çš„é—®é¢˜ï¼ˆå¦‚ï¼šå‘½åé£æ ¼å·®å¼‚ã€æ³¨é‡Šç¼ºå¤±ï¼‰

### ç¬¬å››æ­¥ï¼šæ±‡æ€»æŠ¥å‘Š
**æ‰§è¡Œ"æ±‡æ€»æ‰€æœ‰æ–‡ä»¶æŠ¥å‘Šå¹¶ç”Ÿæˆæœ€ç»ˆå¯¹é½æŠ¥å‘Š"ä»»åŠ¡**

è¯¥ä»»åŠ¡éœ€è¦ï¼š
1. è¯»å–æ‰€æœ‰å·²å®Œæˆæ–‡ä»¶ä»»åŠ¡çš„ç»“æœ
2. è¯»å–æ‰€æœ‰éƒ¨åˆ†æŠ¥å‘Šæ–‡ä»¶ï¼ˆ`{crate_dir}/alignment_reports/*_report.md`ï¼‰
3. æ±‡æ€»æ‰€æœ‰æ–‡ä»¶çš„é—®é¢˜ç»Ÿè®¡
4. æŒ‰ä¸¥é‡ç¨‹åº¦åˆ†ç±»ï¼ˆHigh/Medium/Lowï¼‰
5. ç”Ÿæˆå®Œæ•´çš„ Markdown æŠ¥å‘Šï¼ŒåŒ…å«ä»¥ä¸‹ç« èŠ‚ï¼š
   - **æ€»ä½“ç»“è®º**ï¼šä¸€è‡´/ä¸ä¸€è‡´/éƒ¨åˆ†ä¸€è‡´
   - **ç»Ÿè®¡ä¿¡æ¯**ï¼š
     * æ€»æ–‡ä»¶æ•°ã€å·²åˆ†ææ–‡ä»¶æ•°
     * æ€»é—®é¢˜æ•°ã€High/Medium/Low æ•°é‡
     * å„æ–‡ä»¶é—®é¢˜åˆ†å¸ƒ
   - **æŒ‰æ–‡ä»¶åˆ†ç»„çš„é—®é¢˜æ‘˜è¦**ï¼šæ¯ä¸ªæ–‡ä»¶çš„é—®é¢˜æ•°é‡ã€ä¸¥é‡ç¨‹åº¦åˆ†å¸ƒã€å…³é”®é—®é¢˜æ¦‚è¿°
   - **å…³é”®é—®é¢˜è¯¦ç»†åˆ—è¡¨**ï¼šæ±‡æ€»æ‰€æœ‰ High å’Œ Medium çº§åˆ«é—®é¢˜çš„è¯¦ç»†ä¿¡æ¯ï¼ˆåŒ…å«æ–‡ä»¶åã€å‡½æ•°åã€é—®é¢˜æè¿°ã€ä¸¥é‡ç¨‹åº¦ã€ä»£ç å¯¹æ¯”ï¼‰
   - **æ”¹è¿›å»ºè®®**ï¼šé’ˆå¯¹å‘ç°çš„é—®é¢˜æå‡ºå…·ä½“çš„ä¿®å¤å»ºè®®
6. å°†æŠ¥å‘Šå†™å…¥æ–‡ä»¶ï¼š{report_file}

### ç¬¬äº”æ­¥ï¼šè¾“å‡ºéªŒè¯ç»“æœ
**æœ€åï¼Œå½“æ‰€æœ‰ä»»åŠ¡å®Œæˆåï¼Œç³»ç»Ÿä¼šè¦æ±‚ä½ ç”Ÿæˆæœ€ç»ˆæ€»ç»“**

åœ¨æœ€ç»ˆæ€»ç»“ä¸­ï¼Œä½ éœ€è¦ï¼š
1. è¯»å–ç”Ÿæˆçš„æŠ¥å‘Šæ–‡ä»¶ï¼š{report_file}
2. æ ¹æ®æŠ¥å‘Šå†…å®¹åˆ¤æ–­ is_alignedï¼š
   - å¦‚æœæ‰€æœ‰é—®é¢˜éƒ½æ˜¯ Low çº§åˆ«æˆ–æ²¡æœ‰é—®é¢˜ â†’ is_aligned: true
   - å¦‚æœå­˜åœ¨ High æˆ– Medium çº§åˆ«é—®é¢˜ â†’ is_aligned: false
3. ç”Ÿæˆç®€æ´çš„ summary æè¿°
4. **å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼è¾“å‡ºéªŒè¯ç»“æœ**ï¼š
```json
{{
  "is_aligned": true/false,
  "summary": "æ€»ä½“ç»“è®ºï¼ˆä¸€è‡´/ä¸ä¸€è‡´/éƒ¨åˆ†ä¸€è‡´ï¼‰",
  "report_path": "{report_file}"
}}
```

**é‡è¦**ï¼šæœ€ç»ˆæ€»ç»“å¿…é¡»è¾“å‡ºå®Œæ•´çš„ JSON æ ¼å¼ï¼Œä¸è¦åŒ…å«å…¶ä»–æ–‡æœ¬ã€‚

## é‡è¦æé†’
- **å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°5ä¸ªæ­¥éª¤é¡ºåºæ‰§è¡Œ**
- **å¿…é¡»æŒ‰æ–‡ä»¶æ‹†åˆ†ä»»åŠ¡ï¼Œè€Œä¸æ˜¯æŒ‰åˆ†æç»´åº¦æ‹†åˆ†**ï¼ˆè¿™æ ·æ‰èƒ½æ”¯æŒå¤§è§„æ¨¡ä»£ç ï¼‰
- **ç¬¬ä¸€æ­¥å®Œæˆåç«‹å³åˆ›å»ºä»»åŠ¡åˆ—è¡¨ï¼Œä¸è¦ç›´æ¥å¼€å§‹åˆ†æ**
- **æ¯ä¸ªæ–‡ä»¶ä»»åŠ¡å®Œæˆåç«‹å³ç”Ÿæˆéƒ¨åˆ†æŠ¥å‘Š**ï¼ˆæ”¯æŒå¢é‡æŸ¥çœ‹è¿›åº¦ï¼‰
- **æ¯ä¸ªå­ä»»åŠ¡å¿…é¡»æä¾›è¯¦ç»†çš„ additional_info**
- **é—®é¢˜è®°å½•æ ¼å¼å¿…é¡»ç»Ÿä¸€ï¼ŒåŒ…å«æ–‡ä»¶åã€å‡½æ•°åã€é—®é¢˜æè¿°ã€ä¸¥é‡ç¨‹åº¦ã€ä»£ç å¯¹æ¯”**
- **æœ€ç»ˆå¿…é¡»è¾“å‡ºæœ‰æ•ˆçš„ JSON æ ¼å¼ç»“æœ**

## å¤§è§„æ¨¡ä»£ç å¤„ç†æŠ€å·§
- **æ–‡ä»¶æ‹†åˆ†**ï¼šå¦‚æœå•ä¸ªæ–‡ä»¶è¶…è¿‡ 2000 è¡Œï¼Œå¯ä»¥æŒ‰å‡½æ•°ç»„è¿›ä¸€æ­¥æ‹†åˆ†
- **å¢é‡æŠ¥å‘Š**ï¼šæ¯ä¸ªæ–‡ä»¶åˆ†æå®Œæˆåç«‹å³ç”Ÿæˆéƒ¨åˆ†æŠ¥å‘Šï¼Œä¾¿äºè·Ÿè¸ªè¿›åº¦
- **å¹¶è¡Œæ‰§è¡Œ**ï¼šæ–‡ä»¶ä»»åŠ¡ä¹‹é—´æ— ä¾èµ–ï¼Œå¯ä»¥å¹¶è¡Œæ‰§è¡Œä»¥æé«˜æ•ˆç‡
- **å†…å­˜ä¼˜åŒ–**ï¼šå¯¹äºå¤§æ–‡ä»¶ï¼Œåªè¯»å–éœ€è¦åˆ†æçš„å…³é”®éƒ¨åˆ†ï¼ˆåŸºäºæ ¹ç¬¦å·åˆ—è¡¨ï¼‰
"""

    try:
        result = agent.run(analysis_task)
        # å°è¯•ä»ç»“æœä¸­æå–ç»“æ„åŒ–æ•°æ®
        if isinstance(result, dict):
            return result
        # å¦‚æœè¿”å›çš„æ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•è§£æ JSON
        if isinstance(result, str):
            try:
                parsed: Dict[str, Any] = json.loads(result)
                return parsed
            except json.JSONDecodeError:
                pass
        # é»˜è®¤è¿”å›
        return {
            "is_aligned": True,
            "summary": "éªŒè¯å®Œæˆï¼ˆæ— æ³•è§£æè¯¦ç»†ç»“æœï¼‰",
            "report_path": str(report_file),
        }
    except Exception as e:
        PrettyOutput.auto_print(f"âŒ [verify] åˆ†æè¿‡ç¨‹å‡ºé”™: {e}")
        return {
            "is_aligned": False,
            "summary": "åˆ†æå¤±è´¥",
            "report_path": str(report_file),
        }


def _run_optimization(
    crate_dir: Path,
    project_root: Path,
    report: str,
    config: Dict[str, Any],
    non_interactive: bool,
) -> None:
    """
    è¿è¡Œä»£ç ä¼˜åŒ–ã€‚

    ä½¿ç”¨ CodeAgent åŸºäºå¯¹é½æŠ¥å‘Šä¼˜åŒ– Rust ä»£ç ã€‚
    """
    from jarvis.jarvis_code_agent.code_agent import CodeAgent
    from jarvis.jarvis_c2rust.constants import C2RUST_DIRNAME
    from jarvis.jarvis_c2rust.constants import SYMBOLS_JSONL

    # ç¡®å®š symbols.jsonl æ–‡ä»¶è·¯å¾„
    symbols_path = project_root / C2RUST_DIRNAME / SYMBOLS_JSONL

    # åˆ›å»ºä¼˜åŒ– CodeAgentï¼Œæ·»åŠ  read_symbols å·¥å…·
    agent = CodeAgent(
        name="C2Rust-OptimizationAgent",
        need_summary=False,
        non_interactive=non_interactive,
        append_tools="read_symbols",  # æ·»åŠ  read_symbols å·¥å…·ç”¨äºè¯»å– C ç¬¦å·ä¿¡æ¯
    )

    optimization_task = f"""
ä½ æ˜¯ä¸€ä¸ª C åˆ° Rust ä»£ç è½¬è¯‘çš„ä¼˜åŒ–ä¸“å®¶ï¼Œä¸“é—¨è´Ÿè´£ä¿®å¤åŠŸèƒ½å¯¹é½éªŒè¯ä¸­å‘ç°çš„é—®é¢˜ã€‚

## ä»»åŠ¡ç›®æ ‡
æ ¹æ®åŠŸèƒ½å¯¹é½éªŒè¯æŠ¥å‘Šï¼Œä¼˜åŒ– Rust ä»£ç ä»¥ä¿®å¤ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œç¡®ä¿è½¬è¯‘åçš„ Rust ä»£ç ä¸åŸ C ä»£ç åŠŸèƒ½å®Œå…¨å¯¹é½ã€‚

## å¯¹é½æŠ¥å‘Š
{report}

## é¡¹ç›®ä¿¡æ¯
- é¡¹ç›®æ ¹ç›®å½•: {project_root}
- Rust crate ç›®å½•: {crate_dir}
- æ ¹ç¬¦å·åˆ—è¡¨: {config.get("root_symbols", [])}
- ç¦ç”¨åº“åˆ—è¡¨: {config.get("disabled_libraries", [])}
- é™„åŠ è¯´æ˜: {config.get("additional_notes", "")}

## å¯ç”¨å·¥å…·
1. **read_symbols**: è¯»å– C ç¬¦å·ä¿¡æ¯ï¼ˆç”¨äºå¯¹æ¯” C ä»£ç ï¼‰
   - ç¬¦å·è¡¨æ–‡ä»¶: {symbols_path}
   - ä½¿ç”¨ç¤ºä¾‹: `read_symbols({{"symbols_file": "{symbols_path}", "symbols": ["å‡½æ•°å"]}})`
2. **read_code**: è¯»å– C æºç æˆ– Rust ä»£ç æ–‡ä»¶
   - è¯»å– Rust æ–‡ä»¶æ—¶ï¼Œä½¿ç”¨ç›¸å¯¹äº crate æ ¹ç›®å½•çš„è·¯å¾„ï¼ˆå¦‚ `src/xxx.rs`ï¼‰æˆ–ç»å¯¹è·¯å¾„
   - è¯»å– C æ–‡ä»¶æ—¶ï¼Œä½¿ç”¨ C æºæ–‡ä»¶çš„å®Œæ•´è·¯å¾„
3. **edit_file**: ä¿®æ”¹ Rust ä»£ç æ–‡ä»¶
4. **execute_script**: æ‰§è¡Œç¼–è¯‘å’Œæµ‹è¯•å‘½ä»¤ï¼ˆå¦‚ `cargo check`, `cargo test`ï¼‰

## ä¼˜åŒ–å·¥ä½œæµç¨‹

### ç¬¬ä¸€æ­¥ï¼šåˆ†æé—®é¢˜ï¼ˆANALYZEï¼‰
1. ä»”ç»†é˜…è¯»å¯¹é½æŠ¥å‘Šï¼Œç†è§£æ¯ä¸ªé—®é¢˜çš„ï¼š
   - é—®é¢˜ç±»å‹ï¼ˆå‡½æ•°ç­¾åã€é€»è¾‘ã€é”™è¯¯å¤„ç†ã€å†…å­˜å®‰å…¨ã€å¸ƒå±€å¯¹é½ï¼‰
   - ä¸¥é‡ç¨‹åº¦ï¼ˆHigh/Medium/Lowï¼‰
   - å…·ä½“ä½ç½®ï¼ˆæ–‡ä»¶åã€å‡½æ•°åï¼‰
   - C ä»£ç å’Œ Rust ä»£ç çš„å·®å¼‚

### ç¬¬äºŒæ­¥ï¼šæ”¶é›†ä¿¡æ¯ï¼ˆCOLLECTï¼‰
2. å¯¹äºæ¯ä¸ªéœ€è¦ä¿®å¤çš„é—®é¢˜ï¼š
   - ä½¿ç”¨ `read_code` è¯»å–ç›¸å…³çš„ Rust ä»£ç æ–‡ä»¶
   - ä½¿ç”¨ `read_symbols` è¯»å–å¯¹åº”çš„ C ç¬¦å·ä¿¡æ¯ï¼ˆå¦‚æœéœ€è¦å¯¹æ¯” C å®ç°ï¼‰
   - ä½¿ç”¨ `read_code` è¯»å– C æºç æ–‡ä»¶ï¼ˆå¦‚æœéœ€è¦è¯¦ç»†å¯¹æ¯”ï¼‰

### ç¬¬ä¸‰æ­¥ï¼šæå‡ºæ–¹æ¡ˆï¼ˆHYPOTHESIZEï¼‰
3. é’ˆå¯¹æ¯ä¸ªé—®é¢˜è®¾è®¡ä¿®å¤æ–¹æ¡ˆï¼š
   - åˆ†æé—®é¢˜çš„æ ¹æœ¬åŸå› 
   - è®¾è®¡æœ€å°æ”¹åŠ¨çš„ä¿®å¤æ–¹æ¡ˆ
   - è€ƒè™‘ä¿®å¤åå¯¹å…¶ä»–ä»£ç çš„å½±å“
   - ç¡®ä¿ä¿®å¤æ–¹æ¡ˆç¬¦åˆ Rust æœ€ä½³å®è·µ

### ç¬¬å››æ­¥ï¼šæ‰§è¡Œä¿®å¤ï¼ˆEXECUTEï¼‰
4. é€ä¸ªä¿®å¤é—®é¢˜ï¼š
   - ä½¿ç”¨ `edit_file` å·¥å…·ä¿®æ”¹ Rust ä»£ç 
   - æ¯æ¬¡ä¿®æ”¹åï¼Œä½¿ç”¨ `execute_script` æ‰§è¡Œ `cargo check` éªŒè¯ç¼–è¯‘
   - å¦‚æœæŠ¥å‘Šä¸­æœ‰æµ‹è¯•ç”¨ä¾‹ï¼Œæ‰§è¡Œ `cargo test` éªŒè¯åŠŸèƒ½
   - ç¡®ä¿ä¿®å¤åä»£ç èƒ½å¤Ÿç¼–è¯‘é€šè¿‡

### ç¬¬äº”æ­¥ï¼šåæ€ï¼ˆREVIEWï¼‰
5. ä¿®å¤å®Œæˆåè¿›è¡Œå…¨é¢åæ€ï¼š
   - å®¡æŸ¥ä»£ç è´¨é‡ï¼ˆè¯­æ³•/åŠŸèƒ½/é£æ ¼ï¼‰
   - æ ¸å¯¹åŠŸèƒ½æ˜¯å¦å®Œæˆï¼ŒéªŒè¯æ‰€æœ‰é—®é¢˜éƒ½å·²ä¿®å¤
   - æ£€æŸ¥æ³¢åŠçš„ä»£ç æ˜¯å¦éƒ½è€ƒè™‘åˆ°
   - ç¡®è®¤æ˜¯å¦æœ‰é…å¥—çš„ä¿®æ”¹ï¼ˆå¦‚æ–‡æ¡£ã€æµ‹è¯•ã€é…ç½®ç­‰ï¼‰
   - ç¡®ä¿ä»£ç èƒ½å¤Ÿç¼–è¯‘é€šè¿‡
   - è¿è¡Œç›¸å…³æµ‹è¯•ç¡®ä¿åŠŸèƒ½æ­£ç¡®
   - æ£€æŸ¥æ˜¯å¦å¼•å…¥äº†æ–°çš„é—®é¢˜
   - è¯„ä¼°å½±å“é¢å’Œæ½œåœ¨é£é™©

## ä¼˜åŒ–è¦æ±‚
1. **ä¼˜å…ˆçº§**ï¼šä¼˜å…ˆä¿®å¤ High çº§åˆ«é—®é¢˜ï¼Œç„¶åæ˜¯ Medium çº§åˆ«é—®é¢˜
2. **æœ€å°æ”¹åŠ¨**ï¼šåªä¿®æ”¹å¿…è¦çš„éƒ¨åˆ†ï¼Œä¸è¦è¿›è¡Œæ— å…³çš„é‡æ„
3. **åŠŸèƒ½å¯¹é½**ï¼šç¡®ä¿ä¿®å¤åçš„ Rust ä»£ç ä¸åŸ C ä»£ç åŠŸèƒ½å®Œå…¨ä¸€è‡´
4. **ä»£ç è´¨é‡**ï¼š
   - ä¿æŒä»£ç é£æ ¼å’Œé¡¹ç›®è§„èŒƒ
   - ä½¿ç”¨ Rust æœ€ä½³å®è·µï¼ˆå¦‚ Result ç±»å‹å¤„ç†é”™è¯¯ã€æ‰€æœ‰æƒç³»ç»Ÿç®¡ç†å†…å­˜ï¼‰
   - æ·»åŠ å¿…è¦çš„æ³¨é‡Šè¯´æ˜ä¿®å¤åŸå› 
5. **éªŒè¯**ï¼šæ¯æ¬¡ä¿®æ”¹åå¿…é¡»éªŒè¯ç¼–è¯‘é€šè¿‡ï¼Œä¸è¦ç´¯ç§¯å¤šä¸ªä¿®æ”¹åå†éªŒè¯
6. **ä¸è¦ç ´åå·²æœ‰åŠŸèƒ½**ï¼šä¿®å¤é—®é¢˜æ—¶ï¼Œç¡®ä¿ä¸ä¼šå½±å“å…¶ä»–å·²æ­£å¸¸å·¥ä½œçš„ä»£ç 

## æ³¨æ„äº‹é¡¹
- **C ä»£ç å¯¹æ¯”**ï¼šå¦‚æœéœ€è¦å¯¹æ¯” C å®ç°ï¼Œä½¿ç”¨ `read_symbols` å·¥å…·è¯»å–ç¬¦å·ä¿¡æ¯ï¼Œæˆ–ä½¿ç”¨ `read_code` è¯»å– C æºæ–‡ä»¶
- **Rust æ–‡ä»¶è·¯å¾„**ï¼šè¯»å– Rust æ–‡ä»¶æ—¶ï¼Œä½¿ç”¨ç›¸å¯¹äº crate æ ¹ç›®å½•çš„è·¯å¾„ï¼ˆå¦‚ `src/xxx.rs`ï¼‰
- **ç¼–è¯‘éªŒè¯**ï¼šæ¯æ¬¡ä¿®æ”¹åç«‹å³æ‰§è¡Œ `cargo check` éªŒè¯ç¼–è¯‘ï¼Œä¸è¦ç­‰åˆ°æœ€åæ‰éªŒè¯
- **æµ‹è¯•éªŒè¯**ï¼šå¦‚æœå¯¹é½æŠ¥å‘Šæåˆ°æµ‹è¯•ç”¨ä¾‹ï¼Œæ‰§è¡Œç›¸å…³æµ‹è¯•ç¡®ä¿åŠŸèƒ½æ­£ç¡®

è¯·å¼€å§‹ä¼˜åŒ–ï¼ŒæŒ‰ç…§ä¸Šè¿°å·¥ä½œæµç¨‹é€æ­¥ä¿®å¤é—®é¢˜ã€‚
"""

    try:
        agent.run(optimization_task)
        PrettyOutput.auto_print("âœ… [verify] ä¼˜åŒ–å®Œæˆ")
    except Exception as e:
        PrettyOutput.auto_print(f"âš ï¸  [verify] ä¼˜åŒ–è¿‡ç¨‹å‡ºé”™: {e}")
